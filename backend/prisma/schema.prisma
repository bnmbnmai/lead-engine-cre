// Prisma Schema for Lead Engine CRE
// RTB Platform Database Models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Core User & Auth Models
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String?  @unique
  walletAddress String   @unique
  role          UserRole @default(BUYER)
  nonce         String   @default(uuid())  // For SIWE
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  buyerProfile  BuyerProfile?
  sellerProfile SellerProfile?
  bids          Bid[]
  transactions  Transaction[]
  sessions      Session[]
  apiKeys       ApiKey[]
  escrowVault   EscrowVault?

  @@index([walletAddress])
  @@index([email])
}

enum UserRole {
  BUYER
  SELLER
  ADMIN
}

// ============================================
// Escrow Vault (per-user USDC pool)
// ============================================

model EscrowVault {
  id             String   @id @default(cuid())
  userId         String   @unique
  balance        Decimal  @default(0) @db.Decimal(12, 6) // Available USDC
  totalDeposited Decimal  @default(0) @db.Decimal(12, 6)
  totalSpent     Decimal  @default(0) @db.Decimal(12, 6)
  totalRefunded  Decimal  @default(0) @db.Decimal(12, 6)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User               @relation(fields: [userId], references: [id])
  transactions VaultTransaction[]

  @@index([userId])
}

model VaultTransaction {
  id        String              @id @default(cuid())
  vaultId   String
  type      VaultTransactionType
  amount    Decimal             @db.Decimal(12, 6)
  reference String?             // leadId, bidId, txHash, etc.
  note      String?
  createdAt DateTime            @default(now())

  vault EscrowVault @relation(fields: [vaultId], references: [id])

  @@index([vaultId, createdAt(sort: Desc)])
}

enum VaultTransactionType {
  DEPOSIT   // Buyer funds vault
  DEDUCT    // Bid won or bounty matched
  SETTLE    // Bid settlement (transfer to seller + fee to platform)
  REFUND    // Bid lost refund
  WITHDRAW  // Buyer withdraws to wallet
  FEE       // $1 convenience fee
}

// ============================================
// Hierarchical Verticals
// ============================================

enum VerticalStatus {
  PROPOSED     // Community-submitted, needs admin review
  ACTIVE       // Live and usable in leads/asks
  DEPRECATED   // No new usage, existing data preserved
  REJECTED     // Admin rejected the proposal
}

model Vertical {
  id          String         @id @default(cuid())
  slug        String         @unique   // "solar", "home_services.plumbing"
  name        String                   // "Solar", "Plumbing"
  description String?
  parentId    String?                  // NULL = top-level
  depth       Int            @default(0)  // 0 = root, 1 = child, max 3
  sortOrder   Int            @default(0)

  // Metadata
  attributes  Json?          // { compliance: ["TCPA"], budget: ">10K", icon: "wrench" }
  formConfig  Json?          // Admin form builder config: { fields, steps, gamification } — KEPT for rendering
  aliases     String[]       // ["plumber", "pipe_repair"] for overlap/search
  status      VerticalStatus @default(PROPOSED)

  // Compliance auto-flags
  requiresTcpa    Boolean @default(false)
  requiresKyc     Boolean @default(false)
  restrictedGeos  String[]  // ISO country codes where this vertical is restricted

  // NFT tokenization (set after activation)
  nftTokenId      Int?       // On-chain VerticalNFT token ID
  nftTxHash       String?    // Mint transaction hash
  ownerAddress    String?    // Current NFT owner wallet address
  resaleHistory   Json[]     @default([]) // [{ buyer, seller, price, royalty, txHash, timestamp }]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Self-referential relation
  parent   Vertical?  @relation("VerticalHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Vertical[] @relation("VerticalHierarchy")
  auctions VerticalAuction[]
  fields   VerticalField[] // Structured field definitions (mirrors formConfig fields)

  @@index([parentId])
  @@index([status])
  @@index([slug])
  @@index([depth, status])
  @@index([nftTokenId])
}

// ============================================
// Vertical Field Definitions (Option B)
// ============================================
//
// Promotes formConfig field definitions to first-class DB entities.
// formConfig JSON is KEPT for form rendering; VerticalField is the
// queryable, indexable source of truth for search & autobid filters.
//
// Privacy: contact/PII fields (fullName, email, phone) are created
// with isPii=true, isFilterable=false, isBiddable=false so they
// can never leak into buyer-facing filters or autobid rules.

enum FieldType {
  TEXT
  SELECT
  BOOLEAN
  NUMBER
  TEXTAREA
  EMAIL
  PHONE
  // Future: DATE, RANGE, MULTI_SELECT, FILE_UPLOAD, ADDRESS
}

model VerticalField {
  id           String    @id @default(cuid())
  verticalId   String
  key          String               // "creditScore", "propertyType" — must match formConfig field.key
  label        String               // Human-readable: "Credit Score"
  fieldType    FieldType            // TEXT, SELECT, BOOLEAN, etc.
  required     Boolean   @default(false)
  options      String[]             // For SELECT fields: ["Excellent","Good","Fair","Poor"]
  placeholder  String?              // Form placeholder text
  sortOrder    Int       @default(0) // Display order within the vertical's form

  // Search & Autobid flags
  isFilterable Boolean   @default(true)   // Can buyers filter marketplace search on this field?
  isBiddable   Boolean   @default(false)  // Can buyers set autobid rules targeting this field?
  isPii        Boolean   @default(false)  // True for contact fields — never exposed to buyers

  // Metadata for future use
  description  String?              // Tooltip/help text for admin UI
  validationPattern String?         // Optional regex for input validation
  defaultValue String?              // Default value for new leads

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  vertical     Vertical  @relation(fields: [verticalId], references: [id], onDelete: Cascade)
  fieldFilters BuyerFieldFilter[]

  @@unique([verticalId, key])                // One field per key per vertical
  @@index([verticalId, sortOrder])           // Form rendering order
  @@index([verticalId, isFilterable])        // Search filter queries
  @@index([verticalId, isBiddable])          // Autobid configuration queries
}

model VerticalAuction {
  id            String   @id @default(cuid())
  verticalSlug  String
  tokenId       Int
  auctionId     Int?     // On-chain auction ID
  reservePrice  Float
  startTime     DateTime
  endTime       DateTime
  prePingEndsAt DateTime?  // End of holder-only pre-ping window
  prePingNonce  String?    // Crypto nonce used to compute prePingEndsAt (audit trail)
  highBidder    String?
  highBid       Float    @default(0)
  rawBid        Float?   // Actual bid amount before multiplier

  // Lease lifecycle (quarterly reset)
  leaseEndDate     DateTime?    // Quarterly lease expiry
  renewalDeadline  DateTime?    // Deadline for holder to renew (7-day grace)
  leaseStatus      LeaseStatus  @default(ACTIVE)

  settled       Boolean  @default(false)
  cancelled     Boolean  @default(false)
  extensionCount Int     @default(0)    // Auto-extend counter (max 5)
  txHash        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  vertical      Vertical @relation(fields: [verticalSlug], references: [slug])

  @@index([verticalSlug])
  @@index([settled, cancelled])
  @@index([leaseStatus, leaseEndDate])
  @@index([prePingEndsAt])              // Quarterly reset + pre-ping window queries
  @@index([prePingNonce])               // Nonce audit lookups
  @@index([endTime, settled])           // Active auction monitor
}

enum LeaseStatus {
  ACTIVE
  GRACE_PERIOD
  EXPIRED
  RENEWED
  PAUSED   // Mid-auction: lease check suspended until auction resolves
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())
  userAgent    String?
  ipAddress    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  name        String
  keyHash     String   @unique  // Hashed API key
  prefix      String             // First 8 chars for identification
  permissions String[] @default(["leads:write"])
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  isActive    Boolean  @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
}

model BuyerProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  companyName       String?
  
  // Filtering preferences
  verticals         String[] // ["solar", "mortgage", "roofing"]
  geoFilters        Json?    // { "country": "US", "states": ["CA", "TX"], "excludeStates": ["NY"] }
  
  // Budget settings
  budgetMin         Decimal? @db.Decimal(10, 2)
  budgetMax         Decimal? @db.Decimal(10, 2)
  dailyBudget       Decimal? @db.Decimal(10, 2)
  monthlyBudget     Decimal? @db.Decimal(10, 2)
  
  // Toggles
  acceptOffSite     Boolean  @default(true)
  requireVerified   Boolean  @default(false)
  autoAcceptLeads   Boolean  @default(false)
  holderNotifyOptIn Boolean  @default(false)  // Opt-in for holder priority notifications
  
  // Compliance
  kycStatus         KycStatus @default(PENDING)
  kycVerifiedAt     DateTime?
  jurisdictionHash  String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  preferenceSets  BuyerPreferenceSet[]
}

model BuyerPreferenceSet {
  id              String   @id @default(cuid())
  buyerProfileId  String
  label           String             // User-defined, e.g. "Solar — US West"
  vertical        String             // Single vertical per set
  priority        Int      @default(0) // Lower = higher priority (overlap resolution)

  // Geo
  geoCountries    String[]            // Country codes (e.g. ["US","CA","MX"])
  geoInclude      String[]            // State codes to include
  geoExclude      String[]            // State codes to exclude

  // Budget
  maxBidPerLead   Decimal? @db.Decimal(10, 2)
  dailyBudget     Decimal? @db.Decimal(10, 2)

  // Auto-bid
  autoBidEnabled  Boolean  @default(false)
  autoBidAmount   Decimal? @db.Decimal(10, 2) // Fixed bid amount when auto-bid fires
  minQualityScore Int?     // 0-10000 scale; "bid if score > 80" = 8000

  // Seller targeting
  excludedSellerIds   String[]            // Seller profile IDs to never bid on
  preferredSellerIds  String[]            // Seller profile IDs to prioritise
  minSellerReputation Int?                // 0-10000 scale (matches SellerProfile.reputationScore)
  requireVerifiedSeller Boolean @default(false)

  // Toggles
  acceptOffSite   Boolean  @default(true)
  requireVerified Boolean  @default(false)
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  buyerProfile BuyerProfile @relation(fields: [buyerProfileId], references: [id], onDelete: Cascade)
  fieldFilters BuyerFieldFilter[] // Granular field-level autobid rules

  @@index([buyerProfileId, priority])
  @@index([vertical, isActive])
}

// ============================================
// Field-Level Autobid Filters
// ============================================
//
// Each BuyerFieldFilter targets a specific VerticalField with
// an operator and value. During autobid evaluation, all filters
// for a preference set must pass (AND logic) for the bid to fire.
//
// Example rules:
//   creditScore IN ["Excellent","Good"]         → operator=IN, value=["Excellent","Good"]
//   electricBill >= "$200-$300"                 → operator=GTE, value="$200-$300"
//   roofAge NOT_IN ["New (0-5 years)"]          → operator=NOT_IN, value=["New (0-5 years)"]
//   existingSolar EQUALS true                   → operator=EQUALS, value="true"

enum FilterOperator {
  EQUALS        // Exact match (string or number)
  NOT_EQUALS    // Inverse of EQUALS
  IN            // Value is in the provided list (for SELECT fields)
  NOT_IN        // Value is NOT in the provided list
  GT            // Greater than (NUMBER fields)
  GTE           // Greater than or equal
  LT            // Less than
  LTE           // Less than or equal
  BETWEEN       // Between two values (NUMBER fields, value = JSON [min, max])
  CONTAINS      // Substring match (TEXT fields)
  STARTS_WITH   // Prefix match
}

model BuyerFieldFilter {
  id                String         @id @default(cuid())
  preferenceSetId   String
  verticalFieldId   String
  operator          FilterOperator // EQUALS, IN, GT, LT, BETWEEN, etc.
  value             String         // JSON-encoded value: "\"Excellent\"" or "[\"Good\",\"Fair\"]" or "200"
  isActive          Boolean        @default(true)

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  preferenceSet     BuyerPreferenceSet @relation(fields: [preferenceSetId], references: [id], onDelete: Cascade)
  verticalField     VerticalField      @relation(fields: [verticalFieldId], references: [id], onDelete: Cascade)

  @@unique([preferenceSetId, verticalFieldId]) // One filter per field per preference set
  @@index([preferenceSetId, isActive])         // Autobid evaluation: fetch all active filters for a set
  @@index([verticalFieldId])                   // Admin: "which buyers filter on this field?"
}

model SellerProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  companyName     String?
  verticals       String[]
  reputationScore Decimal  @default(5000) @db.Decimal(5, 0)  // 0-10000 basis points
  totalLeadsSold  Int      @default(0)
  
  // Compliance
  isVerified      Boolean  @default(false)
  kycStatus       KycStatus @default(PENDING)
  kycVerifiedAt   DateTime?
  
  // Conversion tracking
  conversionPixelUrl   String?   // e.g. Google Ads conversion pixel URL
  conversionWebhookUrl String?   // Server-to-server POST endpoint
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads Lead[]
  asks  Ask[]
}

enum KycStatus {
  PENDING
  IN_PROGRESS
  VERIFIED
  REJECTED
  EXPIRED
}

// ============================================
// Marketplace Ask Model
// ============================================

model Ask {
  id              String    @id @default(cuid())
  sellerId        String
  
  // What the seller is looking for
  vertical        String
  geoTargets      Json      // { "country": "US", "states": ["CA"], "radius": { "lat": 34.0, "lng": -118.2, "miles": 50 } }
  
  // Pricing
  reservePrice    Decimal   @db.Decimal(10, 2)
  buyNowPrice     Decimal?  @db.Decimal(10, 2)
  
  // Parameters (seller requirements)
  parameters      Json?     // { "minCreditScore": 650, "propertyType": ["single_family"] }
  
  // Status
  status          AskStatus @default(ACTIVE)
  
  // Toggles
  acceptOffSite   Boolean   @default(true)
  
  // Auction settings
  auctionDuration Int       @default(60)    // seconds — 60s sealed-bid auction
  revealWindow    Int       @default(0)     // seconds — deprecated, no separate reveal
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  expiresAt       DateTime?

  seller SellerProfile @relation(fields: [sellerId], references: [id])
  leads  Lead[]

  @@index([vertical, status])
  @@index([sellerId])
  @@index([status, createdAt])
}

enum AskStatus {
  ACTIVE
  PAUSED
  EXPIRED
  CANCELLED
}

// ============================================
// Lead & RTB Models
// ============================================

model Lead {
  id              String      @id @default(cuid())
  sellerId        String
  askId           String?     // Optional link to Ask
  vertical        String      // "solar", "mortgage", "roofing", etc.
  geo             Json        // { "country": "US", "state": "CA", "zip": "90210", "city": "Beverly Hills", "region": "West" }
  source          LeadSource  @default(PLATFORM)
  status          LeadStatus  @default(PENDING_AUCTION)
  
  // Lead data (encrypted/hashed sensitive fields)
  dataHash        String?     // Hash of PII for ZK verification
  encryptedData   String?     // Encrypted lead details
  
  // Custom parameters (for matching)
  parameters      Json?       // { "creditScore": 720, "propertyType": "single_family", "loanAmount": 350000 }
  
  // Ad tracking (UTM / campaign attribution)
  adSource        Json?       // { "utm_source": "google", "utm_medium": "cpc", "utm_campaign": "solar_q1", "ad_id": "...", "ad_platform": "google" }
  
  // Pricing
  reservePrice    Decimal?    @db.Decimal(10, 2)
  buyNowPrice     Decimal?    @db.Decimal(10, 2)  // Set when lead becomes UNSOLD (reserve * 1.2)
  winningBid      Decimal?    @db.Decimal(10, 2)
  
  // NFT tokenization
  nftTokenId      String?     @unique
  nftContractAddr String?
  nftMintTxHash   String?     // Tx hash of the on-chain LeadNFT mint
  
  // Compliance
  tcpaConsentAt   DateTime?
  consentProof    String?     // IPFS hash or on-chain reference
  isVerified      Boolean     @default(false)
  qualityScore    Int?        // CRE quality score (0-10000), computed by CREVerifier at creation
  
  // Timestamps
  createdAt       DateTime    @default(now())
  auctionStartAt  DateTime?
  auctionEndAt    DateTime?
  soldAt          DateTime?
  expiresAt       DateTime?

  // Relations
  seller       SellerProfile @relation(fields: [sellerId], references: [id])
  ask          Ask?          @relation(fields: [askId], references: [id])
  bids         Bid[]
  transactions Transaction[]
  auctionRoom  AuctionRoom?

  @@index([vertical, status])
  @@index([sellerId])
  @@index([status, createdAt])
  @@index([status, expiresAt])    // Buy It Now marketplace queries
  @@index([askId])
  @@index([createdAt])          // conversion analytics time-range
}

enum LeadSource {
  PLATFORM     // Platform-hosted form
  API          // Seller API submission
  OFFSITE      // Off-site form (buyer toggle)
  DEMO         // Demo panel injected data (TD-08 fix)
}

enum LeadStatus {
  PENDING_PING      // @deprecated — kept for data compat
  IN_PING_POST      // @deprecated — kept for data compat
  PENDING_AUCTION
  IN_AUCTION        // Active 60s sealed-bid auction
  REVEAL_PHASE      // @deprecated — kept for data compat
  SOLD
  UNSOLD            // Auction ended with no winner → available for Buy It Now
  EXPIRED
  CANCELLED
  DISPUTED
}

// ============================================
// Auction Room (Socket.IO tracking)
// ============================================

model AuctionRoom {
  id              String   @id @default(cuid())
  leadId          String   @unique
  roomId          String   @unique  // Socket.IO room identifier
  
  // State
  phase           AuctionPhase @default(BIDDING)
  bidCount        Int          @default(0)
  highestBid      Decimal?     @db.Decimal(10, 2)
  highestBidder   String?
  
  // Timing
  startedAt       DateTime     @default(now())
  prePingEndsAt   DateTime?    // End of holder-only pre-ping window
  prePingNonce    String?      // Crypto nonce for audit trail / recomputation
  biddingEndsAt   DateTime
  revealEndsAt    DateTime?    // @deprecated — no separate reveal phase
  
  // Effective bid tracking (holder multiplier applied)
  effectiveBid    Decimal?     @db.Decimal(10, 2)
  
  // Participants (cached for quick lookup)
  participants    String[]     // Array of user IDs
  
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([phase, biddingEndsAt])
  @@index([prePingEndsAt])           // Socket room pre-ping window filtering
}

enum AuctionPhase {
  PING_POST     // @deprecated — kept for data compat
  BIDDING       // Active sealed-bid auction
  REVEAL        // @deprecated — kept for data compat
  RESOLVED
  CANCELLED
}

model Bid {
  id           String    @id @default(cuid())
  leadId       String
  buyerId      String
  
  // Commit-reveal
  commitment   String?   // Hash of (amount, salt) for sealed bids
  amount       Decimal?  @db.Decimal(10, 2)  // Revealed amount (raw)
  effectiveBid Decimal?  @db.Decimal(10, 2)  // Effective bid (after holder multiplier)
  salt         String?   // Revealed salt
  isHolder     Boolean   @default(false)     // Vertical NFT holder at bid time
  
  status       BidStatus @default(PENDING)
  source       BidSource @default(MANUAL)
  
  // Pre-bid escrow
  escrowTxHash     String?   // Tx hash of pre-bid escrow funding
  escrowRefunded   Boolean   @default(false) // True if escrow was refunded (loser)
  
  // Timestamps
  createdAt    DateTime  @default(now())
  revealedAt   DateTime?
  processedAt  DateTime?

  // Relations
  lead  Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  buyer User @relation(fields: [buyerId], references: [id])

  @@unique([leadId, buyerId]) // One bid per buyer per lead
  @@index([leadId, status])
  @@index([buyerId])
  @@index([leadId, amount(sort: Desc)])  // For finding highest bid
  @@index([leadId, effectiveBid(sort: Desc), isHolder(sort: Desc)])  // Holder tie-breaker
}

enum BidStatus {
  PENDING      // Committed but not revealed
  REVEALED     // Revealed, awaiting resolution
  ACCEPTED     // Won the auction
  OUTBID       // Lost to higher bid
  REJECTED     // Failed compliance or below reserve
  WITHDRAWN    // Buyer withdrew
  EXPIRED      // Not revealed in time
}

enum BidSource {
  MANUAL       // Human via UI
  AUTO_BID     // Auto-bid engine
  AGENT        // MCP agent
}

// ============================================
// Payment & Transaction Models
// ============================================

model Transaction {
  id              String            @id @default(cuid())
  leadId          String
  buyerId         String
  amount          Decimal           @db.Decimal(10, 2)
  platformFee     Decimal?          @db.Decimal(10, 2)
  convenienceFee  Decimal?          @db.Decimal(10, 2)  // $2 for AUTO_BID/AGENT wins
  convenienceFeeType String?        // 'AUTOBID' | 'API' | null
  currency        String            @default("USDC")
  status          TransactionStatus @default(PENDING)
  
  // Blockchain details
  txHash          String?           @unique
  chainId         Int?
  blockNumber     Int?
  
  // Escrow
  escrowAddress   String?
  escrowId        String?           // On-chain escrow ID
  escrowReleased  Boolean           @default(false)
  
  // Timestamps
  createdAt       DateTime          @default(now())
  confirmedAt     DateTime?
  releasedAt      DateTime?

  // Relations
  lead  Lead @relation(fields: [leadId], references: [id])
  buyer User @relation(fields: [buyerId], references: [id])

  @@index([leadId])
  @@index([buyerId])
  @@index([txHash])
  @@index([status, createdAt])
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  ESCROWED
  RELEASED
  FAILED
  REFUNDED
  DISPUTED
}

// ============================================
// Compliance & Audit Models
// ============================================

model ComplianceCheck {
  id           String           @id @default(cuid())
  entityType   String           // "lead", "user", "transaction"
  entityId     String
  checkType    ComplianceType
  status       ComplianceStatus @default(PENDING)
  result       Json?
  message      String?
  checkedAt    DateTime?
  expiresAt    DateTime?
  createdAt    DateTime         @default(now())

  @@index([entityType, entityId])
  @@index([entityId, checkType])
  @@index([status, createdAt])
}

enum ComplianceType {
  TCPA_CONSENT
  KYC
  AML
  GEO_VALIDATION
  FRAUD_CHECK
  PARAMETER_MATCH
}

enum ComplianceStatus {
  PENDING
  PASSED
  FAILED
  MANUAL_REVIEW
  EXPIRED
}

// ============================================
// Analytics (MVP)
// ============================================

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String   // "lead_submitted", "bid_placed", "auction_resolved"
  entityType String?  // "lead", "bid", "user"
  entityId   String?
  userId     String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([eventType, createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
}

// ============================================
// AI Vertical Suggestions
// ============================================

model VerticalSuggestion {
  id              String         @id @default(cuid())
  suggestedSlug   String         @unique
  suggestedName   String
  parentSlug      String
  attributes      Json?
  confidence      Float          @default(0)
  reasoning       String?
  source          String         @default("ai")  // "ai", "rule", "user"
  hitCount        Int            @default(1)
  status          VerticalStatus @default(PROPOSED)

  // Source lead reference (no FK — lead may be deleted)
  sourceLeadId    String?
  sourceText      String?  // Scrubbed description snippet

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([parentSlug])
  @@index([status, hitCount])
}

// ============================================
// Platform Configuration (Key-Value)
// ============================================

model PlatformConfig {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}
