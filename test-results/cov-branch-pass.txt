PASS tests/unit/privacy.service.test.ts
  PrivacyService
    encrypt/decrypt round-trip
      ‚àö should encrypt and decrypt lead PII correctly (4 ms)
      ‚àö should produce different ciphertext for same plaintext (unique IV) (1 ms)
      ‚àö should throw on tampered ciphertext (2 ms)
      ‚àö should throw on tampered auth tag (2 ms)
    encryptBid / decryptBid
      ‚àö should encrypt bid and decrypt with valid commitment (4 ms)
      ‚àö should fail reveal with wrong buyer address (AAD mismatch) (1 ms)
      ‚àö should produce unique commitments for same amount (different salts) (1 ms)
      ‚àö should handle small and large amounts (2 ms)
    encryptTokenMetadata / decryptTokenMetadata
      ‚àö should keep public fields visible and encrypt private fields (1 ms)
      ‚àö should return null encryptedFields when no PII or parameters (1 ms)
    generateCommitment / verifyCommitment
      ‚àö should generate and verify a valid commitment (2 ms)
      ‚àö should fail verification with wrong value (1 ms)
      ‚àö should fail verification with wrong salt (1 ms)

FAIL tests/unit/branch-gaps.test.ts
  ‚óè Test suite failed to run

    [96mtests/unit/branch-gaps.test.ts[0m:[93m474[0m:[93m17[0m - [91merror[0m[90m TS2339: [0mProperty 'seller' does not exist on type 'PrismaClient<PrismaClientOptions, never, DefaultArgs>'.

    [7m474[0m         (prisma.seller.findUnique as jest.Mock).mockResolvedValue({
    [7m   [0m [91m                ~~~~~~[0m
    [96mtests/unit/branch-gaps.test.ts[0m:[93m479[0m:[93m17[0m - [91merror[0m[90m TS2339: [0mProperty 'seller' does not exist on type 'PrismaClient<PrismaClientOptions, never, DefaultArgs>'.

    [7m479[0m         (prisma.seller.update as jest.Mock).mockResolvedValue({});
    [7m   [0m [91m                ~~~~~~[0m

PASS tests/unit/onchain-branches.test.ts
  ACE On-Chain Branches
    ‚àö isKYCValid: should call contract.isKYCValid on-chain (2 ms)
    ‚àö isKYCValid: should catch on-chain error and fallback to DB (2 ms)
    ‚àö canTransact: should call contract.canTransact on-chain (2 ms)
    ‚àö canTransact: on-chain returns false (2 ms)
    ‚àö canTransact: on-chain error falls back gracefully (1 ms)
    ‚àö getReputationScore: should call contract on-chain
    ‚àö getReputationScore: on-chain error falls back to DB
    ‚àö enforceJurisdictionPolicy: on-chain allowed (1 ms)
    ‚àö enforceJurisdictionPolicy: on-chain blocked (3 ms)
    ‚àö enforceJurisdictionPolicy: on-chain error falls back (2 ms)
    ‚àö autoKYC: on-chain success (1 ms)
    ‚àö autoKYC: on-chain failure (1 ms)
    ‚àö updateReputation: on-chain success (1 ms)
    ‚àö updateReputation: on-chain failure (1 ms)
  CRE On-Chain Branches
    ‚àö requestZKFraudDetection: on-chain success (4 ms)
    ‚àö requestZKFraudDetection: on-chain error falls back to local (1 ms)
    ‚àö requestParameterMatchOnChain: on-chain success (1 ms)
    ‚àö requestParameterMatchOnChain: on-chain error (2 ms)
    ‚àö requestGeoValidationOnChain: on-chain success (1 ms)
    ‚àö requestGeoValidationOnChain: on-chain error
  NFT On-Chain Branches
    ‚àö mintLeadNFT: on-chain mint success (2 ms)
    ‚àö mintLeadNFT: on-chain error falls back (1 ms)
    ‚àö recordSaleOnChain: on-chain success (2 ms)
    ‚àö recordSaleOnChain: on-chain error
    ‚àö getTokenMetadata: on-chain success (2 ms)
    ‚àö getTokenMetadata: on-chain error falls back to DB
  X402 On-Chain Branches
    ‚àö createPayment: on-chain with USDC approval (1 ms)
    ‚àö createPayment: on-chain without USDC (no usdc contract) (1 ms)
    ‚àö createPayment: on-chain error (1 ms)
    ‚àö settlePayment: on-chain release (1 ms)
    ‚àö settlePayment: on-chain error (1 ms)
    ‚àö refundPayment: on-chain refund
    ‚àö refundPayment: on-chain error (1 ms)
    ‚àö getPaymentStatus: on-chain status (2 ms)
    ‚àö getPaymentStatus: on-chain error falls back to DB (1 ms)
    ‚àö createPayment: on-chain with sufficient USDC allowance (skip approve) (5 ms)
  NFT updateQualityScoreOnChain On-Chain
    ‚àö updateQualityScoreOnChain: on-chain success (1 ms)
    ‚àö updateQualityScoreOnChain: on-chain error (1 ms)
    ‚àö updateQualityScoreOnChain: skips for offchain token (1 ms)

PASS tests/crm-webhooks.test.ts
  CRM Webhooks
    Webhook Registration
      ‚àö should register a generic webhook (46 ms)
      ‚àö should register a HubSpot webhook (6 ms)
      ‚àö should register a Zapier webhook (7 ms)
      ‚àö should reject missing URL (6 ms)
      ‚àö should reject invalid format (6 ms)
    Webhook Listing
      ‚àö should list user webhooks (10 ms)
    Webhook Deletion
      ‚àö should delete an existing webhook (11 ms)
      ‚àö should return 404 for non-existent webhook (6 ms)
    HubSpot Payload Format
      ‚àö should transform leads to HubSpot contact properties (6 ms)
    Zapier Payload Format
      ‚àö should produce flat key-value objects for Zapier (6 ms)
    CRM Export
      ‚àö should return JSON export (6 ms)
      ‚àö should return CSV export (4 ms)
    CRM Push
      ‚àö should return error when no webhook URL provided (5 ms)
      ‚àö should push leads with specific leadIds (5 ms)
      ‚àö should push default SOLD leads when no leadIds provided (5 ms)
      ‚àö should return 502 when webhook URL returns error (6 ms)
    Generic Webhook Format
      ‚àö should fire generic format with standard payload (7 ms)
    CRM Export (country filter)
      ‚àö should filter leads by country when specified (4 ms)
      ‚àö should return 500 on export error (5 ms)
    fireCRMWebhooks (resilience)
      ‚àö should increment failure count when webhook fetch throws (2 ms)
      ‚àö should handle empty leads array (1 ms)
    Event Filtering
      ‚àö should skip webhooks not subscribed to event

  console.warn
    CRE: unknown country code "ZZ" for lead lead-xx

    [0m [90m 146 |[39m         [36mif[39m ([33m![39mgetAllCountryCodes()[33m.[39mincludes(country)) {
     [90m 147 |[39m             [90m// Allow unknown countries ‚Äî don't block, just log[39m
    [31m[1m>[22m[39m[90m 148 |[39m             console[33m.[39mwarn([32m`CRE: unknown country code "${country}" for lead ${lead.id}`[39m)[33m;[39m
     [90m     |[39m                     [31m[1m^[22m[39m
     [90m 149 |[39m             [36mawait[39m [36mthis[39m[33m.[39mlogCheck(lead[33m.[39mid[33m,[39m [32m'GEO_VALIDATION'[39m[33m,[39m [32m'PASSED'[39m[33m,[39m [32m`Unknown country ${country} ‚Äî allowed`[39m)[33m;[39m
     [90m 150 |[39m             [36mreturn[39m { isValid[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 151 |[39m         }[0m

      at CREService.verifyGeo (src/services/cre.service.ts:148:21)
      at CREService.verifyLead (src/services/cre.service.ts:70:18)
      at async Object.<anonymous> (tests/unit/cre.service.test.ts:409:28)

PASS tests/unit/cre.service.test.ts
  CREService
    verifyLead
      ‚àö should return invalid for non-existent lead (2 ms)
      ‚àö should return valid for already-verified lead
      ‚àö should fail for lead without TCPA consent (1 ms)
      ‚àö should fail for lead with expired TCPA consent
      ‚àö should fail for invalid US state (1 ms)
      ‚àö should pass for valid lead with all checks (1 ms)
      ‚àö should fail for data integrity mismatch (2 ms)
    getQualityScore
      ‚àö should return 0 for non-existent lead (1 ms)
      ‚àö should return base score for minimal lead (3 ms)
      ‚àö should add bonuses for verified lead with all fields
      ‚àö should cap quality score at 10000 (1 ms)
    matchLeadToAsk
      ‚àö should return no match for nonexistent lead or ask (1 ms)
      ‚àö should reject on vertical mismatch (1 ms)
      ‚àö should match with correct vertical and geo
      ‚àö should reject when lead geo not in targeted states (1 ms)
      ‚àö should add score for meeting reserve price
      ‚àö should match using "regions" key (not just "states")
      ‚àö should reject on country mismatch (1 ms)
      ‚àö should add geo bonus when no region restrictions
    requestZKFraudDetection
      ‚àö should return invalid for non-existent lead (1 ms)
      ‚àö should verify locally and return valid for existing lead (4 ms)
    requestParameterMatchOnChain
      ‚àö should return error when contract not configured
    requestGeoValidationOnChain
      ‚àö should return error when contract not configured
    verifyLead (geo edge cases)
      ‚àö should fail for lead with no geo data (1 ms)
      ‚àö should allow lead with unknown country code (13 ms)

PASS tests/compliance/ace-simulation.test.ts
  ACE Compliance Simulation
    cross-border: NY mortgage cross-border
      ‚àö FL‚ÜíNY mortgage: BLOCKED (2 ms)
    cross-border: NY mortgage cross-border (reverse)
      ‚àö NY‚ÜíFL mortgage: BLOCKED (1 ms)
    cross-border: CA mortgage cross-border
      ‚àö CA‚ÜíTX mortgage: BLOCKED
    cross-border: FL mortgage cross-border
      ‚àö FL‚ÜíTX mortgage: BLOCKED (1 ms)
    cross-border: TX‚ÜíCO unrestricted
      ‚àö TX‚ÜíCO mortgage: ALLOWED (1 ms)
    cross-border: WA‚ÜíOR unrestricted
      ‚àö WA‚ÜíOR mortgage: ALLOWED
    cross-border: MA‚ÜíOH unrestricted (MA not in list)
      ‚àö MA‚ÜíOH mortgage: ALLOWED (1 ms)
    cross-border: NY insurance cross-border
      ‚àö TX‚ÜíNY insurance: BLOCKED (2 ms)
    cross-border: CA‚ÜíFL insurance (CA not restricted for insurance)
      ‚àö CA‚ÜíFL insurance: ALLOWED (1 ms)
    cross-border: FL‚ÜíGA unrestricted insurance
      ‚àö FL‚ÜíGA insurance: ALLOWED (1 ms)
    cross-border: Solar unrestricted
      ‚àö FL‚ÜíCA solar: ALLOWED
    cross-border: Solar unrestricted NY‚ÜíTX
      ‚àö NY‚ÜíTX solar: ALLOWED (1 ms)
    cross-border: Solar unrestricted CA‚ÜíWA
      ‚àö CA‚ÜíWA solar: ALLOWED
    cross-border: Roofing unrestricted
      ‚àö FL‚ÜíNY roofing: ALLOWED
    cross-border: Same-state mortgage NY
      ‚àö NY‚ÜíNY mortgage: ALLOWED
    cross-border: Same-state insurance CA
      ‚àö CA‚ÜíCA insurance: ALLOWED
    cross-border: Same-state solar FL
      ‚àö FL‚ÜíFL solar: ALLOWED (1 ms)
    reputation scenarios
      ‚àö reputation 0 + 100 = 100 (1 ms)
      ‚àö reputation 5000 + 500 = 5500
      ‚àö reputation 9900 + 200 = 10000 (1 ms)
      ‚àö reputation 100 + -500 = 0
      ‚àö reputation 10000 + 0 = 10000 (1 ms)
      ‚àö reputation 0 + 0 = 0
      ‚àö reputation 3000 + -3000 = 0 (1 ms)
      ‚àö reputation 7500 + 2500 = 10000
    off-site API fraud edge cases
      ‚àö should block known fraudulent wallet (blacklist hit) (1 ms)
      ‚àö should handle wallet with no history (first interaction) (1 ms)
      ‚àö should auto-KYC new wallet and persist (1 ms)
      ‚àö should handle rapid sequential compliance checks (5 ms)
    jurisdiction policy enforcement
      ‚àö should allow when no DB restriction (1 ms)
      ‚àö should block when DB has failed check (1 ms)

PASS tests/unit/ace.service.test.ts
  ACEService
    enforceJurisdictionPolicy
      ‚àö should allow when no restrictions exist in DB (2 ms)
      ‚àö should block when DB restriction exists (1 ms)
    checkCrossBorderCompliance
      ‚àö should allow same-state transactions (1 ms)
      ‚àö should block cross-state mortgage with restricted states
      ‚àö should block cross-state insurance with NY
      ‚àö should allow cross-state solar (unrestricted vertical) (1 ms)
      ‚àö should allow cross-state mortgage between unrestricted states
      ‚àö should handle CA mortgage cross-border restriction (3 ms)
    autoKYC
      ‚àö should create KYC check in database (off-chain) (2 ms)
      ‚àö should set 1-year expiry on KYC check (1 ms)
    updateReputation
      ‚àö should update reputation in DB for existing seller (1 ms)
      ‚àö should clamp reputation at 0 (floor)
      ‚àö should clamp reputation at 10000 (ceiling) (1 ms)
      ‚àö should return error for non-existent seller
    isKYCValid
      ‚àö should return false for unknown wallet (off-chain) (1 ms)
      ‚àö should return true for valid KYC in DB (1 ms)
    canTransact
      ‚àö should block blacklisted user
      ‚àö should block user without KYC (1 ms)
      ‚àö should allow valid user with KYC
    getReputationScore
      ‚àö should return DB score for existing seller
      ‚àö should return default 5000 for unknown wallet (1 ms)
    isBlacklisted
      ‚àö should return true when fraud check exists
      ‚àö should return false when no fraud check (1 ms)
    checkFullCompliance
      ‚àö should pass when both parties are compliant and lead has TCPA
      ‚àö should fail when seller is blacklisted
      ‚àö should fail when lead not found (1 ms)
      ‚àö should fail when lead has no TCPA consent (2 ms)
    enforceJurisdictionPolicy (policy branch)
      ‚àö should allow unrestricted country vertical (1 ms)
    autoKYC (proofHash branch)
      ‚àö should accept custom proofHash
    checkCrossBorderCompliance (cross-country)
      ‚àö should return requirements for US‚ÜíEU cross-country trade (1 ms)
    edge cases
      ‚àö should handle empty wallet address gracefully (1 ms)
      ‚àö should handle cross-border with empty vertical
      ‚àö should return true for user with VERIFIED buyerProfile (1 ms)

PASS tests/e2e/demo-flow.test.ts
  E2E Demo Flow
    full pipeline simulation
      ‚àö should complete all 8 steps successfully (6 ms)
      ‚àö should handle non-compliant buyer (ACE blocked)
      ‚àö should handle wrong buyer address in bid reveal (2 ms)
    ZK + Privacy cross-service
      ‚àö should generate matching ZK proof and privacy commitment for same lead (3 ms)
      ‚àö should geo-match mortgage lead to CA buyer criteria (2 ms)

PASS tests/unit/zk.service.test.ts
  ZKService
    generateFraudProof
      ‚àö should generate a valid fraud proof with all fields (5 ms)
      ‚àö should produce different proofs for different leads (4 ms)
      ‚àö should handle missing optional fields (1 ms)
    verifyProofLocally
      ‚àö should verify a valid fraud proof (1 ms)
      ‚àö should reject an empty/zero proof (1 ms)
      ‚àö should reject a proof with no public inputs
      ‚àö should reject a proof with zero commitment
    generateGeoParameterMatchProof
      ‚àö should detect matching geo state (2 ms)
      ‚àö should detect non-matching geo state (1 ms)
      ‚àö should detect parameter threshold failures (1 ms)
    generateBidCommitment
      ‚àö should generate a valid bid commitment (2 ms)
      ‚àö should produce unique commitments for same amount (random salts) (1 ms)

PASS tests/unit/x402.service.test.ts
  X402Service
    createPayment
      ‚àö should create off-chain escrow when no contract configured (2 ms)
    settlePayment
      ‚àö should settle off-chain transaction (1 ms)
      ‚àö should return error for non-existent transaction (1 ms)
      ‚àö should return error for transaction without escrow
    refundPayment
      ‚àö should refund off-chain transaction (1 ms)
      ‚àö should return error for non-existent transaction (1 ms)
    getPaymentStatus
      ‚àö should return null for non-existent transaction (3 ms)
      ‚àö should return DB-based status for off-chain escrow (1 ms)
    generatePaymentHeader
      ‚àö should generate correct x402 payment headers (1 ms)
      ‚àö should handle zero amount
    edge cases
      ‚àö should handle double-settle gracefully (1 ms)
      ‚àö should create escrow with large USDC amount
      ‚àö should create escrow with zero amount (1 ms)
      ‚àö should handle refund for already-refunded transaction
      ‚àö should return error for refund without escrow (1 ms)
      ‚àö should return status with releasedAt timestamp (1 ms)
      ‚àö should generate headers with custom escrow ID

PASS tests/unit/nft.service.test.ts
  NFTService
    mintLeadNFT
      ‚àö should return error for non-existent lead (1 ms)
      ‚àö should return existing tokenId if already minted
      ‚àö should create off-chain pseudo-tokenId when no contract (3 ms)
    recordSaleOnChain
      ‚àö should succeed for off-chain token (logged only) (3 ms)
    getTokenMetadata
      ‚àö should return null for non-existent token (1 ms)
      ‚àö should return DB-based metadata for off-chain token (1 ms)
    updateQualityScoreOnChain
      ‚àö should succeed silently for off-chain token (no-op)
    mintLeadNFT (dataHash branch)
      ‚àö should use existing dataHash when available (2 ms)
      ‚àö should handle lead with no geo state (1 ms)
      ‚àö should handle lead with no seller wallet (1 ms)
    getTokenMetadata (field coverage)
      ‚àö should populate all metadata fields from DB (1 ms)
      ‚àö should return null dataHash as ZeroHash (1 ms)
    recordSaleOnChain (coverage)
      ‚àö should handle zero sale price

PASS tests/security/privacy-audit.test.ts
  Privacy Audit
    no plaintext leakage
      ‚àö should never contain original PII in ciphertext (2 ms)
      ‚àö should never contain bid amount in ciphertext (1 ms)
      ‚àö should never contain parameter values in token metadata encryption (1 ms)
    commitment integrity
      ‚àö should detect tampered bid (commitment mismatch on reveal) (1 ms)
      ‚àö should prevent bid amount manipulation (3 ms)
    AAD binding
      ‚àö should prevent buyer A from decrypting buyer B bid
      ‚àö should prevent case-altered address from decrypting (1 ms)
    PII at rest
      ‚àö should produce ciphertext of sufficient length for PII data (1 ms)
      ‚àö should not store PII fields in public metadata (1 ms)
    key sensitivity
      ‚àö should produce deterministic data hash for same PII

PASS tests/auto-bid.test.ts
  Auto-Bid Service
    Quality Score Gate
      ‚àö should bid when lead score exceeds minimum (2 ms)
      ‚àö should skip when lead score is below minimum (bid if score > 80 = 8000) (1 ms)
      ‚àö should bid when no quality score gate is set (1 ms)
    Geo Include/Exclude Filtering
      ‚àö should bid when state is in include list
      ‚àö should skip when state is NOT in include list (1 ms)
      ‚àö should skip when state is in exclude list (1 ms)
      ‚àö should skip when country does not match (1 ms)
    Off-Site Lead Rejection
      ‚àö should reject off-site lead when acceptOffSite is false
      ‚àö should accept off-site lead when acceptOffSite is true (1 ms)
    Daily Budget Enforcement
      ‚àö should skip when daily budget would be exceeded (1 ms)
      ‚àö should bid when within daily budget
    Verified-Only Toggle
      ‚àö should skip unverified lead when requireVerified is true (1 ms)
    Reserve Price Check
      ‚àö should skip when bid amount is below reserve (2 ms)
    Multi-Buyer Concurrent Auto-Bid
      ‚àö should place bids for multiple matching buyers on the same lead (1 ms)
    Vertical-Specific Rules (Solar vs Mortgage)
      ‚àö should only match preference sets for the correct vertical (1 ms)
      ‚àö should return empty when no preference sets match the vertical
    Duplicate Bid Prevention
      ‚àö should skip if buyer already bid on this lead (1 ms)
    Max Bid Per Lead Cap
      ‚àö should skip when bid exceeds max per lead (1 ms)
    Batch Evaluate Leads
      ‚àö should evaluate batch of leads from DB
      ‚àö should return empty results for no matching leads (1 ms)
      ‚àö should handle bid creation errors in batch (1 ms)

----------------------|---------|----------|---------|---------|-----------------------------------------------------------------
File                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                               
----------------------|---------|----------|---------|---------|-----------------------------------------------------------------
All files             |   92.87 |    85.03 |   97.67 |   93.42 |                                                                 
 routes               |   84.52 |    85.82 |   92.85 |   86.45 |                                                                 
  crm.routes.ts       |   84.52 |    85.82 |   92.85 |   86.45 | 141-142,198-199,253-259,273-277,282-283,300-301,306-307,328-329 
 services             |   95.19 |     84.7 |     100 |   95.25 |                                                                 
  ace.service.ts      |   94.95 |    90.56 |     100 |   94.91 | 38-42,195,258                                                   
  auto-bid.service.ts |     100 |    82.05 |     100 |     100 | 117,234-260                                                     
  cre.service.ts      |    92.3 |    83.15 |     100 |    92.5 | 43-47,171-175,261-262,293-294                                   
  nft.service.ts      |   97.14 |    88.67 |     100 |    97.1 | 53,57                                                           
  privacy.service.ts  |   98.21 |     87.5 |     100 |   98.21 | 31                                                              
  x402.service.ts     |   96.15 |    78.18 |     100 |    96.1 | 57,61,67                                                        
  zk.service.ts       |      90 |     87.5 |     100 |      90 | 108-109,116-117                                                 
----------------------|---------|----------|---------|---------|-----------------------------------------------------------------
Test Suites: 1 failed, 12 passed, 13 total
Tests:       241 passed, 241 total
Snapshots:   0 total
Time:        3.376 s
Ran all test suites.

---STDERR---
