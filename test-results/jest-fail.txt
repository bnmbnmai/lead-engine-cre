node.exe : PASS tests/security/privacy-audit.test.ts
At C:\Program Files\nodejs\npx.ps1:29 char:3
+   & $NODE_EXE $NPX_CLI_JS $args
+   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (PASS tests/sec 
   u...y-audit.test.ts:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  Privacy Audit
    no plaintext leakage
      ΓêÜ should never contain original PII in ciphertext 
(7 ms)
      ΓêÜ should never contain bid amount in ciphertext (2 
ms)
      ΓêÜ should never contain parameter values in token 
metadata encryption (1 ms)
    commitment integrity
      ΓêÜ should detect tampered bid (commitment mismatch 
on reveal) (2 ms)
      ΓêÜ should prevent bid amount manipulation (3 ms)
    AAD binding
      ΓêÜ should prevent buyer A from decrypting buyer B 
bid (1 ms)
      ΓêÜ should prevent case-altered address from 
decrypting (1 ms)
    PII at rest
      ΓêÜ should produce ciphertext of sufficient length 
for PII data (1 ms)
      ΓêÜ should not store PII fields in public metadata
    key sensitivity
      ΓêÜ should produce deterministic data hash for same 
PII

PASS tests/crm-webhooks.test.ts
  CRM Webhooks
    Webhook Registration
      ΓêÜ should register a generic webhook (31 ms)
      ΓêÜ should register a HubSpot webhook (9 ms)
      ΓêÜ should register a Zapier webhook (7 ms)
      ΓêÜ should reject missing URL (8 ms)
      ΓêÜ should reject invalid format (6 ms)
    Webhook Listing
      ΓêÜ should list user webhooks (13 ms)
    Webhook Deletion
      ΓêÜ should delete an existing webhook (13 ms)
      ΓêÜ should return 404 for non-existent webhook (5 ms)
    HubSpot Payload Format
      ΓêÜ should transform leads to HubSpot contact 
properties (7 ms)
    Zapier Payload Format
      ΓêÜ should produce flat key-value objects for Zapier 
(7 ms)
    CRM Export
      ΓêÜ should return JSON export (5 ms)
      ΓêÜ should return CSV export (6 ms)
    CRM Push
      ΓêÜ should return error when no webhook URL provided 
(6 ms)
    Generic Webhook Format
      ΓêÜ should fire generic format with standard payload 
(6 ms)
    Event Filtering
      ΓêÜ should skip webhooks not subscribed to event

  console.warn
    CRE: unknown country code "ZZ" for lead lead-xx

    [0m [90m 146 |[39m         [36mif[39m ([33m![39mgetAllCountryCodes()[33m.[39mincludes(country)) {
     [90m 147 |[39m             [90m// Allow unknown countries ΓÇö don't block, just log[39m
    [31m[1m>[22m[39m[90m 148 |[39m             console[33m.[39mwarn([32m`CRE: unknown country code "${country}" for lead ${lead.id}`[39m)[33m;[39m
     [90m     |[39m                     [31m[1m^[22m[39m
     [90m 149 |[39m             [36mawait[39m [36mthis[39m[33m.[39mlogCheck(lead[33m.[39mid[33m,[39m [32m'GEO_VALIDATION'[39m[33m,[39m [32m'PASSED'[39m[33m,[39m [32m`Unknown country ${country} ΓÇö allowed`[39m)[33m;[39m
     [90m 150 |[39m             [36mreturn[39m { isValid[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 151 |[39m         }[0m

      at CREService.verifyGeo (src/services/cre.service.ts:148:21)
      at CREService.verifyLead (src/services/cre.service.ts:70:18)
      at async Object.<anonymous> (tests/unit/cre.service.test.ts:409:28)

PASS tests/unit/cre.service.test.ts
  CREService
    verifyLead
      ΓêÜ should return invalid for non-existent lead (2 ms)
      ΓêÜ should return valid for already-verified lead
      ΓêÜ should fail for lead without TCPA consent (2 ms)
      ΓêÜ should fail for lead with expired TCPA consent
      ΓêÜ should fail for invalid US state (1 ms)
      ΓêÜ should pass for valid lead with all checks (1 ms)
      ΓêÜ should fail for data integrity mismatch (3 ms)
    getQualityScore
      ΓêÜ should return 0 for non-existent lead (1 ms)
      ΓêÜ should return base score for minimal lead (1 ms)
      ΓêÜ should add bonuses for verified lead with all 
fields (1 ms)
      ΓêÜ should cap quality score at 10000
    matchLeadToAsk
      ΓêÜ should return no match for nonexistent lead or 
ask (1 ms)
      ΓêÜ should reject on vertical mismatch (1 ms)
      ΓêÜ should match with correct vertical and geo (1 ms)
      ΓêÜ should reject when lead geo not in targeted states
      ΓêÜ should add score for meeting reserve price (1 ms)
      ΓêÜ should match using "regions" key (not just 
"states") (1 ms)
      ΓêÜ should reject on country mismatch (1 ms)
      ΓêÜ should add geo bonus when no region restrictions
    requestZKFraudDetection
      ΓêÜ should return invalid for non-existent lead
      ΓêÜ should verify locally and return valid for 
existing lead (4 ms)
    requestParameterMatchOnChain
      ΓêÜ should return error when contract not configured 
(2 ms)
    requestGeoValidationOnChain
      ΓêÜ should return error when contract not configured 
(1 ms)
    verifyLead (geo edge cases)
      ΓêÜ should fail for lead with no geo data (1 ms)
      ΓêÜ should allow lead with unknown country code (11 
ms)

PASS tests/unit/ace.service.test.ts
  ACEService
    enforceJurisdictionPolicy
      ΓêÜ should allow when no restrictions exist in DB (2 
ms)
      ΓêÜ should block when DB restriction exists (1 ms)
    checkCrossBorderCompliance
      ΓêÜ should allow same-state transactions (1 ms)
      ΓêÜ should block cross-state mortgage with restricted 
states
      ΓêÜ should block cross-state insurance with NY (1 ms)
      ΓêÜ should allow cross-state solar (unrestricted 
vertical)
      ΓêÜ should allow cross-state mortgage between 
unrestricted states (1 ms)
      ΓêÜ should handle CA mortgage cross-border restriction
    autoKYC
      ΓêÜ should create KYC check in database (off-chain) 
(3 ms)
      ΓêÜ should set 1-year expiry on KYC check (1 ms)
    updateReputation
      ΓêÜ should update reputation in DB for existing 
seller (1 ms)
      ΓêÜ should clamp reputation at 0 (floor) (1 ms)
      ΓêÜ should clamp reputation at 10000 (ceiling)
      ΓêÜ should return error for non-existent seller (1 ms)
    isKYCValid
      ΓêÜ should return false for unknown wallet 
(off-chain) (1 ms)
      ΓêÜ should return true for valid KYC in DB
    canTransact
      ΓêÜ should block blacklisted user (1 ms)
      ΓêÜ should block user without KYC (1 ms)
      ΓêÜ should allow valid user with KYC
    getReputationScore
      ΓêÜ should return DB score for existing seller (1 ms)
      ΓêÜ should return default 5000 for unknown wallet (1 
ms)
    isBlacklisted
      ΓêÜ should return true when fraud check exists
      ΓêÜ should return false when no fraud check (1 ms)
    checkFullCompliance
      ΓêÜ should pass when both parties are compliant and 
lead has TCPA (1 ms)
      ΓêÜ should fail when seller is blacklisted
      ΓêÜ should fail when lead not found (1 ms)
      ΓêÜ should fail when lead has no TCPA consent (1 ms)
    enforceJurisdictionPolicy (policy branch)
      ΓêÜ should allow unrestricted country vertical (1 ms)
    autoKYC (proofHash branch)
      ΓêÜ should accept custom proofHash (1 ms)
    checkCrossBorderCompliance (cross-country)
      ΓêÜ should return requirements for USΓåÆEU 
cross-country trade (1 ms)
    edge cases
      ΓêÜ should handle empty wallet address gracefully (1 
ms)
      ΓêÜ should handle cross-border with empty vertical
      ΓêÜ should return true for user with VERIFIED 
buyerProfile (1 ms)

PASS tests/compliance/ace-simulation.test.ts
  ACE Compliance Simulation
    cross-border: NY mortgage cross-border
      ΓêÜ FLΓåÆNY mortgage: BLOCKED
    cross-border: NY mortgage cross-border (reverse)
      ΓêÜ NYΓåÆFL mortgage: BLOCKED
    cross-border: CA mortgage cross-border
      ΓêÜ CAΓåÆTX mortgage: BLOCKED (1 ms)
    cross-border: FL mortgage cross-border
      ΓêÜ FLΓåÆTX mortgage: BLOCKED
    cross-border: TXΓåÆCO unrestricted
      ΓêÜ TXΓåÆCO mortgage: ALLOWED (1 ms)
    cross-border: WAΓåÆOR unrestricted
      ΓêÜ WAΓåÆOR mortgage: ALLOWED
    cross-border: MAΓåÆOH unrestricted (MA not in list)
      ΓêÜ MAΓåÆOH mortgage: ALLOWED (1 ms)
    cross-border: NY insurance cross-border
      ΓêÜ TXΓåÆNY insurance: BLOCKED
    cross-border: CAΓåÆFL insurance (CA not restricted for 
insurance)
      ΓêÜ CAΓåÆFL insurance: ALLOWED (1 ms)
    cross-border: FLΓåÆGA unrestricted insurance
      ΓêÜ FLΓåÆGA insurance: ALLOWED
    cross-border: Solar unrestricted
      ΓêÜ FLΓåÆCA solar: ALLOWED (1 ms)
    cross-border: Solar unrestricted NYΓåÆTX
      ΓêÜ NYΓåÆTX solar: ALLOWED
    cross-border: Solar unrestricted CAΓåÆWA
      ΓêÜ CAΓåÆWA solar: ALLOWED (3 ms)
    cross-border: Roofing unrestricted
      ΓêÜ FLΓåÆNY roofing: ALLOWED (1 ms)
    cross-border: Same-state mortgage NY
      ΓêÜ NYΓåÆNY mortgage: ALLOWED
    cross-border: Same-state insurance CA
      ΓêÜ CAΓåÆCA insurance: ALLOWED (1 ms)
    cross-border: Same-state solar FL
      ΓêÜ FLΓåÆFL solar: ALLOWED
    reputation scenarios
      ΓêÜ reputation 0 + 100 = 100 (1 ms)
      ΓêÜ reputation 5000 + 500 = 5500 (1 ms)
      ΓêÜ reputation 9900 + 200 = 10000
      ΓêÜ reputation 100 + -500 = 0 (1 ms)
      ΓêÜ reputation 10000 + 0 = 10000
      ΓêÜ reputation 0 + 0 = 0 (1 ms)
      ΓêÜ reputation 3000 + -3000 = 0
      ΓêÜ reputation 7500 + 2500 = 10000
    off-site API fraud edge cases
      ΓêÜ should block known fraudulent wallet (blacklist 
hit) (1 ms)
      ΓêÜ should handle wallet with no history (first 
interaction)
      ΓêÜ should auto-KYC new wallet and persist (1 ms)
      ΓêÜ should handle rapid sequential compliance checks 
(3 ms)
    jurisdiction policy enforcement
      ΓêÜ should allow when no DB restriction (1 ms)
      ΓêÜ should block when DB has failed check

PASS tests/unit/privacy.service.test.ts
  PrivacyService
    encrypt/decrypt round-trip
      ΓêÜ should encrypt and decrypt lead PII correctly (2 
ms)
      ΓêÜ should produce different ciphertext for same 
plaintext (unique IV) (1 ms)
      ΓêÜ should throw on tampered ciphertext (4 ms)
      ΓêÜ should throw on tampered auth tag (1 ms)
    encryptBid / decryptBid
      ΓêÜ should encrypt bid and decrypt with valid 
commitment (1 ms)
      ΓêÜ should fail reveal with wrong buyer address (AAD 
mismatch) (1 ms)
      ΓêÜ should produce unique commitments for same amount 
(different salts)
      ΓêÜ should handle small and large amounts
    encryptTokenMetadata / decryptTokenMetadata
      ΓêÜ should keep public fields visible and encrypt 
private fields (1 ms)
      ΓêÜ should return null encryptedFields when no PII or 
parameters (1 ms)
    generateCommitment / verifyCommitment
      ΓêÜ should generate and verify a valid commitment (1 
ms)
      ΓêÜ should fail verification with wrong value (1 ms)
      ΓêÜ should fail verification with wrong salt (1 ms)

PASS tests/unit/x402.service.test.ts
  X402Service
    createPayment
      ΓêÜ should create off-chain escrow when no contract 
configured (1 ms)
    settlePayment
      ΓêÜ should settle off-chain transaction (1 ms)
      ΓêÜ should return error for non-existent transaction 
(2 ms)
      ΓêÜ should return error for transaction without escrow
    refundPayment
      ΓêÜ should refund off-chain transaction
      ΓêÜ should return error for non-existent transaction 
(1 ms)
    getPaymentStatus
      ΓêÜ should return null for non-existent transaction
      ΓêÜ should return DB-based status for off-chain escrow
    generatePaymentHeader
      ΓêÜ should generate correct x402 payment headers (1 
ms)
      ΓêÜ should handle zero amount
    edge cases
      ΓêÜ should handle double-settle gracefully (1 ms)
      ΓêÜ should create escrow with large USDC amount
      ΓêÜ should create escrow with zero amount (1 ms)
      ΓêÜ should handle refund for already-refunded 
transaction
      ΓêÜ should return error for refund without escrow (1 
ms)
      ΓêÜ should return status with releasedAt timestamp (3 
ms)
      ΓêÜ should generate headers with custom escrow ID (1 
ms)

PASS tests/unit/nft.service.test.ts
  NFTService
    mintLeadNFT
      ΓêÜ should return error for non-existent lead (2 ms)
      ΓêÜ should return existing tokenId if already minted 
(2 ms)
      ΓêÜ should create off-chain pseudo-tokenId when no 
contract (2 ms)
    recordSaleOnChain
      ΓêÜ should succeed for off-chain token (logged only)
    getTokenMetadata
      ΓêÜ should return null for non-existent token (1 ms)
      ΓêÜ should return DB-based metadata for off-chain 
token (1 ms)
    updateQualityScoreOnChain
      ΓêÜ should succeed silently for off-chain token 
(no-op)
    mintLeadNFT (dataHash branch)
      ΓêÜ should use existing dataHash when available
      ΓêÜ should handle lead with no geo state (1 ms)
      ΓêÜ should handle lead with no seller wallet (1 ms)
    getTokenMetadata (field coverage)
      ΓêÜ should populate all metadata fields from DB (1 ms)
      ΓêÜ should return null dataHash as ZeroHash
    recordSaleOnChain (coverage)
      ΓêÜ should handle zero sale price (2 ms)

PASS tests/unit/zk.service.test.ts
  ZKService
    generateFraudProof
      ΓêÜ should generate a valid fraud proof with all 
fields (2 ms)
      ΓêÜ should produce different proofs for different 
leads (4 ms)
      ΓêÜ should handle missing optional fields (3 ms)
    verifyProofLocally
      ΓêÜ should verify a valid fraud proof (1 ms)
      ΓêÜ should reject an empty/zero proof
      ΓêÜ should reject a proof with no public inputs (1 ms)
      ΓêÜ should reject a proof with zero commitment (1 ms)
    generateGeoParameterMatchProof
      ΓêÜ should detect matching geo state (1 ms)
      ΓêÜ should detect non-matching geo state (1 ms)
      ΓêÜ should detect parameter threshold failures (1 ms)
    generateBidCommitment
      ΓêÜ should generate a valid bid commitment (1 ms)
      ΓêÜ should produce unique commitments for same amount 
(random salts)

PASS tests/e2e/demo-flow.test.ts
  E2E Demo Flow
    full pipeline simulation
      ΓêÜ should complete all 8 steps successfully (4 ms)
      ΓêÜ should handle non-compliant buyer (ACE blocked)
      ΓêÜ should handle wrong buyer address in bid reveal 
(1 ms)
    ZK + Privacy cross-service
      ΓêÜ should generate matching ZK proof and privacy 
commitment for same lead (1 ms)
      ΓêÜ should geo-match mortgage lead to CA buyer 
criteria (1 ms)

PASS tests/auto-bid.test.ts
  Auto-Bid Service
    Quality Score Gate
      ΓêÜ should bid when lead score exceeds minimum (1 ms)
      ΓêÜ should skip when lead score is below minimum (bid 
if score > 80 = 8000)
      ΓêÜ should bid when no quality score gate is set (1 
ms)
    Geo Include/Exclude Filtering
      ΓêÜ should bid when state is in include list
      ΓêÜ should skip when state is NOT in include list (1 
ms)
      ΓêÜ should skip when state is in exclude list (1 ms)
      ΓêÜ should skip when country does not match
    Off-Site Lead Rejection
      ΓêÜ should reject off-site lead when acceptOffSite is 
false (1 ms)
      ΓêÜ should accept off-site lead when acceptOffSite is 
true (1 ms)
    Daily Budget Enforcement
      ΓêÜ should skip when daily budget would be exceeded
      ΓêÜ should bid when within daily budget (1 ms)
    Verified-Only Toggle
      ΓêÜ should skip unverified lead when requireVerified 
is true (2 ms)
    Reserve Price Check
      ΓêÜ should skip when bid amount is below reserve (1 
ms)
    Multi-Buyer Concurrent Auto-Bid
      ΓêÜ should place bids for multiple matching buyers on 
the same lead (1 ms)
    Vertical-Specific Rules (Solar vs Mortgage)
      ΓêÜ should only match preference sets for the correct 
vertical
      ΓêÜ should return empty when no preference sets match 
the vertical (1 ms)
    Duplicate Bid Prevention
      ΓêÜ should skip if buyer already bid on this lead
    Max Bid Per Lead Cap
      ΓêÜ should skip when bid exceeds max per lead (1 ms)

Test Suites: 11 passed, 11 total
Tests:       192 passed, 192 total
Snapshots:   0 total
Time:        2.035 s
Ran all test suites.
