PASS tests/unit/onchain-branches.test.ts
  ACE On-Chain Branches
    âˆš isKYCValid: should call contract.isKYCValid on-chain (4 ms)
    âˆš isKYCValid: should catch on-chain error and fallback to DB (2 ms)
    âˆš canTransact: should call contract.canTransact on-chain (2 ms)
    âˆš canTransact: on-chain returns false (1 ms)
    âˆš canTransact: on-chain error falls back gracefully (2 ms)
    âˆš getReputationScore: should call contract on-chain (1 ms)
    âˆš getReputationScore: on-chain error falls back to DB (1 ms)
    âˆš enforceJurisdictionPolicy: on-chain allowed (1 ms)
    âˆš enforceJurisdictionPolicy: on-chain blocked (2 ms)
    âˆš enforceJurisdictionPolicy: on-chain error falls back (4 ms)
    âˆš autoKYC: on-chain success (1 ms)
    âˆš autoKYC: on-chain failure (1 ms)
    âˆš updateReputation: on-chain success
    âˆš updateReputation: on-chain failure
  CRE On-Chain Branches
    âˆš requestZKFraudDetection: on-chain success (3 ms)
    âˆš requestZKFraudDetection: on-chain error falls back to local (2 ms)
    âˆš requestParameterMatchOnChain: on-chain success (1 ms)
    âˆš requestParameterMatchOnChain: on-chain error (1 ms)
    âˆš requestGeoValidationOnChain: on-chain success (1 ms)
    âˆš requestGeoValidationOnChain: on-chain error (1 ms)
  NFT On-Chain Branches
    âˆš mintLeadNFT: on-chain mint success (1 ms)
    âˆš mintLeadNFT: on-chain error falls back (1 ms)
    âˆš recordSaleOnChain: on-chain success (1 ms)
    âˆš recordSaleOnChain: on-chain error (3 ms)
    âˆš getTokenMetadata: on-chain success (1 ms)
    âˆš getTokenMetadata: on-chain error falls back to DB (1 ms)
  X402 On-Chain Branches
    âˆš createPayment: on-chain with USDC approval (1 ms)
    âˆš createPayment: on-chain without USDC (no usdc contract) (1 ms)
    âˆš createPayment: on-chain error
    âˆš settlePayment: on-chain release (1 ms)
    âˆš settlePayment: on-chain error (1 ms)
    âˆš refundPayment: on-chain refund (1 ms)
    âˆš refundPayment: on-chain error
    âˆš getPaymentStatus: on-chain status (1 ms)
    âˆš getPaymentStatus: on-chain error falls back to DB
    âˆš createPayment: on-chain with sufficient USDC allowance (skip approve)
  NFT updateQualityScoreOnChain On-Chain
    âˆš updateQualityScoreOnChain: on-chain success (1 ms)
    âˆš updateQualityScoreOnChain: on-chain error (1 ms)
    âˆš updateQualityScoreOnChain: skips for offchain token (1 ms)

PASS tests/crm-webhooks.test.ts
  CRM Webhooks
    Webhook Registration
      âˆš should register a generic webhook (33 ms)
      âˆš should register a HubSpot webhook (11 ms)
      âˆš should register a Zapier webhook (7 ms)
      âˆš should reject missing URL (9 ms)
      âˆš should reject invalid format (6 ms)
    Webhook Listing
      âˆš should list user webhooks (12 ms)
    Webhook Deletion
      âˆš should delete an existing webhook (11 ms)
      âˆš should return 404 for non-existent webhook (7 ms)
    HubSpot Payload Format
      âˆš should transform leads to HubSpot contact properties (7 ms)
    Zapier Payload Format
      âˆš should produce flat key-value objects for Zapier (7 ms)
    CRM Export
      âˆš should return JSON export (7 ms)
      âˆš should return CSV export (5 ms)
    CRM Push
      âˆš should return error when no webhook URL provided (7 ms)
      âˆš should push leads with specific leadIds (6 ms)
      âˆš should push default SOLD leads when no leadIds provided (6 ms)
      âˆš should return 502 when webhook URL returns error (6 ms)
    Generic Webhook Format
      âˆš should fire generic format with standard payload (7 ms)
    CRM Export (country filter)
      âˆš should filter leads by country when specified (5 ms)
      âˆš should return 500 on export error (5 ms)
    fireCRMWebhooks (resilience)
      âˆš should increment failure count when webhook fetch throws (2 ms)
      âˆš should handle empty leads array (1 ms)
    Event Filtering
      âˆš should skip webhooks not subscribed to event (1 ms)

PASS tests/auto-bid.test.ts
  Auto-Bid Service
    Quality Score Gate
      âˆš should bid when lead score exceeds minimum (2 ms)
      âˆš should skip when lead score is below minimum (bid if score > 80 = 8000) (1 ms)
      âˆš should bid when no quality score gate is set (1 ms)
    Geo Include/Exclude Filtering
      âˆš should bid when state is in include list (1 ms)
      âˆš should skip when state is NOT in include list
      âˆš should skip when state is in exclude list (1 ms)
      âˆš should skip when country does not match (1 ms)
    Off-Site Lead Rejection
      âˆš should reject off-site lead when acceptOffSite is false (1 ms)
      âˆš should accept off-site lead when acceptOffSite is true (1 ms)
    Daily Budget Enforcement
      âˆš should skip when daily budget would be exceeded
      âˆš should bid when within daily budget (3 ms)
    Verified-Only Toggle
      âˆš should skip unverified lead when requireVerified is true
    Reserve Price Check
      âˆš should skip when bid amount is below reserve (1 ms)
    Multi-Buyer Concurrent Auto-Bid
      âˆš should place bids for multiple matching buyers on the same lead (1 ms)
    Vertical-Specific Rules (Solar vs Mortgage)
      âˆš should only match preference sets for the correct vertical (1 ms)
      âˆš should return empty when no preference sets match the vertical (1 ms)
    Duplicate Bid Prevention
      âˆš should skip if buyer already bid on this lead (1 ms)
    Max Bid Per Lead Cap
      âˆš should skip when bid exceeds max per lead
    Batch Evaluate Leads
      âˆš should evaluate batch of leads from DB (1 ms)
      âˆš should return empty results for no matching leads (1 ms)
      âˆš should handle bid creation errors in batch (1 ms)

PASS tests/compliance/ace-simulation.test.ts
  ACE Compliance Simulation
    cross-border: NY mortgage cross-border
      âˆš FLâ†’NY mortgage: BLOCKED (1 ms)
    cross-border: NY mortgage cross-border (reverse)
      âˆš NYâ†’FL mortgage: BLOCKED
    cross-border: CA mortgage cross-border
      âˆš CAâ†’TX mortgage: BLOCKED (3 ms)
    cross-border: FL mortgage cross-border
      âˆš FLâ†’TX mortgage: BLOCKED (1 ms)
    cross-border: TXâ†’CO unrestricted
      âˆš TXâ†’CO mortgage: ALLOWED (1 ms)
    cross-border: WAâ†’OR unrestricted
      âˆš WAâ†’OR mortgage: ALLOWED
    cross-border: MAâ†’OH unrestricted (MA not in list)
      âˆš MAâ†’OH mortgage: ALLOWED (1 ms)
    cross-border: NY insurance cross-border
      âˆš TXâ†’NY insurance: BLOCKED (1 ms)
    cross-border: CAâ†’FL insurance (CA not restricted for insurance)
      âˆš CAâ†’FL insurance: ALLOWED
    cross-border: FLâ†’GA unrestricted insurance
      âˆš FLâ†’GA insurance: ALLOWED (1 ms)
    cross-border: Solar unrestricted
      âˆš FLâ†’CA solar: ALLOWED (1 ms)
    cross-border: Solar unrestricted NYâ†’TX
      âˆš NYâ†’TX solar: ALLOWED
    cross-border: Solar unrestricted CAâ†’WA
      âˆš CAâ†’WA solar: ALLOWED (1 ms)
    cross-border: Roofing unrestricted
      âˆš FLâ†’NY roofing: ALLOWED
    cross-border: Same-state mortgage NY
      âˆš NYâ†’NY mortgage: ALLOWED (1 ms)
    cross-border: Same-state insurance CA
      âˆš CAâ†’CA insurance: ALLOWED (4 ms)
    cross-border: Same-state solar FL
      âˆš FLâ†’FL solar: ALLOWED (1 ms)
    reputation scenarios
      âˆš reputation 0 + 100 = 100 (1 ms)
      âˆš reputation 5000 + 500 = 5500
      âˆš reputation 9900 + 200 = 10000 (1 ms)
      âˆš reputation 100 + -500 = 0 (1 ms)
      âˆš reputation 10000 + 0 = 10000
      âˆš reputation 0 + 0 = 0 (1 ms)
      âˆš reputation 3000 + -3000 = 0 (1 ms)
      âˆš reputation 7500 + 2500 = 10000
    off-site API fraud edge cases
      âˆš should block known fraudulent wallet (blacklist hit) (1 ms)
      âˆš should handle wallet with no history (first interaction)
      âˆš should auto-KYC new wallet and persist (2 ms)
      âˆš should handle rapid sequential compliance checks (3 ms)
    jurisdiction policy enforcement
      âˆš should allow when no DB restriction (1 ms)
      âˆš should block when DB has failed check (1 ms)

  console.warn
    CRE: unknown country code "ZZ" for lead lead-xx

    [0m [90m 146 |[39m         [36mif[39m ([33m![39mgetAllCountryCodes()[33m.[39mincludes(country)) {
     [90m 147 |[39m             [90m// Allow unknown countries â€” don't block, just log[39m
    [31m[1m>[22m[39m[90m 148 |[39m             console[33m.[39mwarn([32m`CRE: unknown country code "${country}" for lead ${lead.id}`[39m)[33m;[39m
     [90m     |[39m                     [31m[1m^[22m[39m
     [90m 149 |[39m             [36mawait[39m [36mthis[39m[33m.[39mlogCheck(lead[33m.[39mid[33m,[39m [32m'GEO_VALIDATION'[39m[33m,[39m [32m'PASSED'[39m[33m,[39m [32m`Unknown country ${country} â€” allowed`[39m)[33m;[39m
     [90m 150 |[39m             [36mreturn[39m { isValid[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 151 |[39m         }[0m

      at CREService.verifyGeo (src/services/cre.service.ts:148:21)
      at CREService.verifyLead (src/services/cre.service.ts:70:18)
      at async Object.<anonymous> (tests/unit/cre.service.test.ts:409:28)

PASS tests/unit/cre.service.test.ts
  CREService
    verifyLead
      âˆš should return invalid for non-existent lead (2 ms)
      âˆš should return valid for already-verified lead (1 ms)
      âˆš should fail for lead without TCPA consent (1 ms)
      âˆš should fail for lead with expired TCPA consent (1 ms)
      âˆš should fail for invalid US state
      âˆš should pass for valid lead with all checks (1 ms)
      âˆš should fail for data integrity mismatch (1 ms)
    getQualityScore
      âˆš should return 0 for non-existent lead (1 ms)
      âˆš should return base score for minimal lead (1 ms)
      âˆš should add bonuses for verified lead with all fields (1 ms)
      âˆš should cap quality score at 10000 (1 ms)
    matchLeadToAsk
      âˆš should return no match for nonexistent lead or ask
      âˆš should reject on vertical mismatch (1 ms)
      âˆš should match with correct vertical and geo (1 ms)
      âˆš should reject when lead geo not in targeted states
      âˆš should add score for meeting reserve price (1 ms)
      âˆš should match using "regions" key (not just "states") (1 ms)
      âˆš should reject on country mismatch
      âˆš should add geo bonus when no region restrictions (1 ms)
    requestZKFraudDetection
      âˆš should return invalid for non-existent lead (1 ms)
      âˆš should verify locally and return valid for existing lead (3 ms)
    requestParameterMatchOnChain
      âˆš should return error when contract not configured (1 ms)
    requestGeoValidationOnChain
      âˆš should return error when contract not configured (1 ms)
    verifyLead (geo edge cases)
      âˆš should fail for lead with no geo data (1 ms)
      âˆš should allow lead with unknown country code (12 ms)

PASS tests/unit/ace.service.test.ts
  ACEService
    enforceJurisdictionPolicy
      âˆš should allow when no restrictions exist in DB (2 ms)
      âˆš should block when DB restriction exists (1 ms)
    checkCrossBorderCompliance
      âˆš should allow same-state transactions
      âˆš should block cross-state mortgage with restricted states (1 ms)
      âˆš should block cross-state insurance with NY
      âˆš should allow cross-state solar (unrestricted vertical) (1 ms)
      âˆš should allow cross-state mortgage between unrestricted states
      âˆš should handle CA mortgage cross-border restriction (3 ms)
    autoKYC
      âˆš should create KYC check in database (off-chain) (2 ms)
      âˆš should set 1-year expiry on KYC check (1 ms)
    updateReputation
      âˆš should update reputation in DB for existing seller (1 ms)
      âˆš should clamp reputation at 0 (floor)
      âˆš should clamp reputation at 10000 (ceiling) (1 ms)
      âˆš should return error for non-existent seller
    isKYCValid
      âˆš should return false for unknown wallet (off-chain)
      âˆš should return true for valid KYC in DB (1 ms)
    canTransact
      âˆš should block blacklisted user (1 ms)
      âˆš should block user without KYC
      âˆš should allow valid user with KYC (1 ms)
    getReputationScore
      âˆš should return DB score for existing seller (1 ms)
      âˆš should return default 5000 for unknown wallet
    isBlacklisted
      âˆš should return true when fraud check exists (1 ms)
      âˆš should return false when no fraud check (1 ms)
    checkFullCompliance
      âˆš should pass when both parties are compliant and lead has TCPA
      âˆš should fail when seller is blacklisted (1 ms)
      âˆš should fail when lead not found
      âˆš should fail when lead has no TCPA consent (1 ms)
    enforceJurisdictionPolicy (policy branch)
      âˆš should allow unrestricted country vertical (2 ms)
    autoKYC (proofHash branch)
      âˆš should accept custom proofHash
    checkCrossBorderCompliance (cross-country)
      âˆš should return requirements for USâ†’EU cross-country trade (1 ms)
    edge cases
      âˆš should handle empty wallet address gracefully
      âˆš should handle cross-border with empty vertical (1 ms)
      âˆš should return true for user with VERIFIED buyerProfile

PASS tests/unit/zk.service.test.ts
  ZKService
    generateFraudProof
      âˆš should generate a valid fraud proof with all fields (5 ms)
      âˆš should produce different proofs for different leads (4 ms)
      âˆš should handle missing optional fields (1 ms)
    verifyProofLocally
      âˆš should verify a valid fraud proof (1 ms)
      âˆš should reject an empty/zero proof (1 ms)
      âˆš should reject a proof with no public inputs (1 ms)
      âˆš should reject a proof with zero commitment (3 ms)
    generateGeoParameterMatchProof
      âˆš should detect matching geo state (2 ms)
      âˆš should detect non-matching geo state (1 ms)
      âˆš should detect parameter threshold failures (1 ms)
    generateBidCommitment
      âˆš should generate a valid bid commitment (1 ms)
      âˆš should produce unique commitments for same amount (random salts) (1 ms)

PASS tests/unit/nft.service.test.ts
  NFTService
    mintLeadNFT
      âˆš should return error for non-existent lead (2 ms)
      âˆš should return existing tokenId if already minted (1 ms)
      âˆš should create off-chain pseudo-tokenId when no contract (2 ms)
    recordSaleOnChain
      âˆš should succeed for off-chain token (logged only)
    getTokenMetadata
      âˆš should return null for non-existent token (1 ms)
      âˆš should return DB-based metadata for off-chain token (1 ms)
    updateQualityScoreOnChain
      âˆš should succeed silently for off-chain token (no-op) (3 ms)
    mintLeadNFT (dataHash branch)
      âˆš should use existing dataHash when available (1 ms)
      âˆš should handle lead with no geo state (1 ms)
      âˆš should handle lead with no seller wallet (1 ms)
    getTokenMetadata (field coverage)
      âˆš should populate all metadata fields from DB (1 ms)
      âˆš should return null dataHash as ZeroHash (1 ms)
    recordSaleOnChain (coverage)
      âˆš should handle zero sale price (1 ms)

PASS tests/unit/x402.service.test.ts
  X402Service
    createPayment
      âˆš should create off-chain escrow when no contract configured (2 ms)
    settlePayment
      âˆš should settle off-chain transaction (1 ms)
      âˆš should return error for non-existent transaction (1 ms)
      âˆš should return error for transaction without escrow
    refundPayment
      âˆš should refund off-chain transaction (1 ms)
      âˆš should return error for non-existent transaction (1 ms)
    getPaymentStatus
      âˆš should return null for non-existent transaction (3 ms)
      âˆš should return DB-based status for off-chain escrow
    generatePaymentHeader
      âˆš should generate correct x402 payment headers
      âˆš should handle zero amount (1 ms)
    edge cases
      âˆš should handle double-settle gracefully
      âˆš should create escrow with large USDC amount
      âˆš should create escrow with zero amount (1 ms)
      âˆš should handle refund for already-refunded transaction
      âˆš should return error for refund without escrow
      âˆš should return status with releasedAt timestamp (1 ms)
      âˆš should generate headers with custom escrow ID

PASS tests/security/privacy-audit.test.ts
  Privacy Audit
    no plaintext leakage
      âˆš should never contain original PII in ciphertext (3 ms)
      âˆš should never contain bid amount in ciphertext (2 ms)
      âˆš should never contain parameter values in token metadata encryption (3 ms)
    commitment integrity
      âˆš should detect tampered bid (commitment mismatch on reveal) (1 ms)
      âˆš should prevent bid amount manipulation (2 ms)
    AAD binding
      âˆš should prevent buyer A from decrypting buyer B bid (1 ms)
      âˆš should prevent case-altered address from decrypting (1 ms)
    PII at rest
      âˆš should produce ciphertext of sufficient length for PII data
      âˆš should not store PII fields in public metadata
    key sensitivity
      âˆš should produce deterministic data hash for same PII (1 ms)

FAIL tests/unit/privacy.service.test.ts
  PrivacyService
    encrypt/decrypt round-trip
      âˆš should encrypt and decrypt lead PII correctly (3 ms)
      âˆš should produce different ciphertext for same plaintext (unique IV) (2 ms)
      Ã— should throw on tampered ciphertext (1 ms)
      âˆš should throw on tampered auth tag (2 ms)
    encryptBid / decryptBid
      âˆš should encrypt bid and decrypt with valid commitment (2 ms)
      âˆš should fail reveal with wrong buyer address (AAD mismatch) (1 ms)
      âˆš should produce unique commitments for same amount (different salts) (1 ms)
      âˆš should handle small and large amounts (1 ms)
    encryptTokenMetadata / decryptTokenMetadata
      âˆš should keep public fields visible and encrypt private fields (1 ms)
      âˆš should return null encryptedFields when no PII or parameters (2 ms)
    generateCommitment / verifyCommitment
      âˆš should generate and verify a valid commitment (2 ms)
      âˆš should fail verification with wrong value (1 ms)
      âˆš should fail verification with wrong salt (1 ms)

  â— PrivacyService â€º encrypt/decrypt round-trip â€º should throw on tampered ciphertext

    expect(received).toThrow()

    Received function did not throw

    [0m [90m 50 |[39m             [90m// Tamper with ciphertext[39m
     [90m 51 |[39m             [36mconst[39m tampered [33m=[39m { [33m...[39mencrypted[33m,[39m ciphertext[33m:[39m encrypted[33m.[39mciphertext[33m.[39mreplace([32m'0'[39m[33m,[39m [32m'1'[39m) }[33m;[39m
    [31m[1m>[22m[39m[90m 52 |[39m             expect(() [33m=>[39m privacyService[33m.[39mdecryptLeadPII(tampered))[33m.[39mtoThrow()[33m;[39m
     [90m    |[39m                                                                   [31m[1m^[22m[39m
     [90m 53 |[39m         })[33m;[39m
     [90m 54 |[39m
     [90m 55 |[39m         it([32m'should throw on tampered auth tag'[39m[33m,[39m () [33m=>[39m {[0m

      at Object.<anonymous> (tests/unit/privacy.service.test.ts:52:67)

PASS tests/e2e/demo-flow.test.ts
  E2E Demo Flow
    full pipeline simulation
      âˆš should complete all 8 steps successfully (7 ms)
      âˆš should handle non-compliant buyer (ACE blocked)
      âˆš should handle wrong buyer address in bid reveal (1 ms)
    ZK + Privacy cross-service
      âˆš should generate matching ZK proof and privacy commitment for same lead (2 ms)
      âˆš should geo-match mortgage lead to CA buyer criteria (4 ms)

----------------------|---------|----------|---------|---------|-----------------------------------------------------------------
File                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                               
----------------------|---------|----------|---------|---------|-----------------------------------------------------------------
All files             |   92.87 |    85.03 |   97.67 |   93.42 |                                                                 
 routes               |   84.52 |    85.82 |   92.85 |   86.45 |                                                                 
  crm.routes.ts       |   84.52 |    85.82 |   92.85 |   86.45 | 141-142,198-199,253-259,273-277,282-283,300-301,306-307,328-329 
 services             |   95.19 |     84.7 |     100 |   95.25 |                                                                 
  ace.service.ts      |   94.95 |    90.56 |     100 |   94.91 | 38-42,195,258                                                   
  auto-bid.service.ts |     100 |    82.05 |     100 |     100 | 117,234-260                                                     
  cre.service.ts      |    92.3 |    83.15 |     100 |    92.5 | 43-47,171-175,261-262,293-294                                   
  nft.service.ts      |   97.14 |    88.67 |     100 |    97.1 | 53,57                                                           
  privacy.service.ts  |   98.21 |     87.5 |     100 |   98.21 | 31                                                              
  x402.service.ts     |   96.15 |    78.18 |     100 |    96.1 | 57,61,67                                                        
  zk.service.ts       |      90 |     87.5 |     100 |      90 | 108-109,116-117                                                 
----------------------|---------|----------|---------|---------|-----------------------------------------------------------------
Test Suites: 1 failed, 11 passed, 12 total
Tests:       1 failed, 240 passed, 241 total
Snapshots:   0 total
Time:        3.161 s
Ran all test suites.

---STDERR---
