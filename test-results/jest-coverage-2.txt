node.exe : PASS tests/crm-webhooks.test.ts
At C:\Program Files\nodejs\npx.ps1:29 char:3
+   & $NODE_EXE $NPX_CLI_JS $args
+   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (PASS tests/crm   
 -webhooks.test.ts:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  CRM Webhooks
    Webhook Registration
      ΓêÜ should register a generic webhook (95 ms)
      ΓêÜ should register a HubSpot webhook (6 ms)
      ΓêÜ should register a Zapier webhook (7 ms)
      ΓêÜ should reject missing URL (6 ms)
      ΓêÜ should reject invalid format (8 ms)
    Webhook Listing
      ΓêÜ should list user webhooks (11 ms)
    Webhook Deletion
      ΓêÜ should delete an existing webhook (13 ms)
      ΓêÜ should return 404 for non-existent webhook (7 ms)
    HubSpot Payload Format
      ΓêÜ should transform leads to HubSpot contact 
properties (7 ms)
    Zapier Payload Format
      ΓêÜ should produce flat key-value objects for Zapier (6 
ms)
    CRM Export
      ΓêÜ should return JSON export (6 ms)
      ΓêÜ should return CSV export (6 ms)
    CRM Push
      ΓêÜ should return error when no webhook URL provided (5 
ms)
    Generic Webhook Format
      ΓêÜ should fire generic format with standard payload (7 
ms)
    Event Filtering
      ΓêÜ should skip webhooks not subscribed to event (1 ms)

PASS tests/unit/privacy.service.test.ts
  PrivacyService
    encrypt/decrypt round-trip
      ΓêÜ should encrypt and decrypt lead PII correctly (3 ms)
      ΓêÜ should produce different ciphertext for same 
plaintext (unique IV) (1 ms)
      ΓêÜ should throw on tampered ciphertext (4 ms)
      ΓêÜ should throw on tampered auth tag (1 ms)
    encryptBid / decryptBid
      ΓêÜ should encrypt bid and decrypt with valid 
commitment (1 ms)
      ΓêÜ should fail reveal with wrong buyer address (AAD 
mismatch) (1 ms)
      ΓêÜ should produce unique commitments for same amount 
(different salts) (1 ms)
      ΓêÜ should handle small and large amounts (1 ms)
    encryptTokenMetadata / decryptTokenMetadata
      ΓêÜ should keep public fields visible and encrypt 
private fields (1 ms)
      ΓêÜ should return null encryptedFields when no PII or 
parameters
    generateCommitment / verifyCommitment
      ΓêÜ should generate and verify a valid commitment (2 ms)
      ΓêÜ should fail verification with wrong value (1 ms)
      ΓêÜ should fail verification with wrong salt (1 ms)

PASS tests/unit/ace.service.test.ts
  ACEService
    enforceJurisdictionPolicy
      ΓêÜ should allow when no restrictions exist in DB (1 ms)
      ΓêÜ should block when DB restriction exists (1 ms)
    checkCrossBorderCompliance
      ΓêÜ should allow same-state transactions
      ΓêÜ should block cross-state mortgage with restricted 
states (1 ms)
      ΓêÜ should block cross-state insurance with NY (1 ms)
      ΓêÜ should allow cross-state solar (unrestricted 
vertical)
      ΓêÜ should allow cross-state mortgage between 
unrestricted states (1 ms)
      ΓêÜ should handle CA mortgage cross-border restriction
    autoKYC
      ΓêÜ should create KYC check in database (off-chain) (1 
ms)
      ΓêÜ should set 1-year expiry on KYC check (1 ms)
    updateReputation
      ΓêÜ should update reputation in DB for existing seller 
(1 ms)
      ΓêÜ should clamp reputation at 0 (floor) (2 ms)
      ΓêÜ should clamp reputation at 10000 (ceiling) (1 ms)
      ΓêÜ should return error for non-existent seller
    isKYCValid
      ΓêÜ should return false for unknown wallet (off-chain) 
(1 ms)
      ΓêÜ should return true for valid KYC in DB (1 ms)
    canTransact
      ΓêÜ should block blacklisted user
      ΓêÜ should block user without KYC (1 ms)
      ΓêÜ should allow valid user with KYC
    getReputationScore
      ΓêÜ should return DB score for existing seller
      ΓêÜ should return default 5000 for unknown wallet (1 ms)
    isBlacklisted
      ΓêÜ should return true when fraud check exists
      ΓêÜ should return false when no fraud check (1 ms)
    checkFullCompliance
      ΓêÜ should pass when both parties are compliant and 
lead has TCPA (1 ms)
      ΓêÜ should fail when seller is blacklisted
      ΓêÜ should fail when lead not found (1 ms)
      ΓêÜ should fail when lead has no TCPA consent
    enforceJurisdictionPolicy (policy branch)
      ΓêÜ should allow unrestricted country vertical (1 ms)
    autoKYC (proofHash branch)
      ΓêÜ should accept custom proofHash (1 ms)
    checkCrossBorderCompliance (cross-country)
      ΓêÜ should return requirements for USΓåÆEU 
cross-country trade
    edge cases
      ΓêÜ should handle empty wallet address gracefully
      ΓêÜ should handle cross-border with empty vertical (2 
ms)
      ΓêÜ should return true for user with VERIFIED 
buyerProfile

PASS tests/unit/cre.service.test.ts
  CREService
    verifyLead
      ΓêÜ should return invalid for non-existent lead (1 ms)
      ΓêÜ should return valid for already-verified lead (1 ms)
      ΓêÜ should fail for lead without TCPA consent (1 ms)
      ΓêÜ should fail for lead with expired TCPA consent (1 
ms)
      ΓêÜ should fail for invalid US state
      ΓêÜ should pass for valid lead with all checks (1 ms)
      ΓêÜ should fail for data integrity mismatch (1 ms)
    getQualityScore
      ΓêÜ should return 0 for non-existent lead (1 ms)
      ΓêÜ should return base score for minimal lead (2 ms)
      ΓêÜ should add bonuses for verified lead with all 
fields (1 ms)
      ΓêÜ should cap quality score at 10000
    matchLeadToAsk
      ΓêÜ should return no match for nonexistent lead or ask 
(1 ms)
      ΓêÜ should reject on vertical mismatch (1 ms)
      ΓêÜ should match with correct vertical and geo
      ΓêÜ should reject when lead geo not in targeted states 
(1 ms)
      ΓêÜ should add score for meeting reserve price (1 ms)
      ΓêÜ should match using "regions" key (not just "states")
      ΓêÜ should reject on country mismatch
      ΓêÜ should add geo bonus when no region restrictions (1 
ms)
    requestZKFraudDetection
      ΓêÜ should return invalid for non-existent lead (1 ms)
      ΓêÜ should verify locally and return valid for existing 
lead (2 ms)
    requestParameterMatchOnChain
      ΓêÜ should return error when contract not configured (1 
ms)
    requestGeoValidationOnChain
      ΓêÜ should return error when contract not configured
    verifyLead (geo edge cases)
      ΓêÜ should fail for lead with no geo data
      ΓêÜ should allow lead with unknown country code (1 ms)

PASS tests/unit/x402.service.test.ts
  X402Service
    createPayment
      ΓêÜ should create off-chain escrow when no contract 
configured (1 ms)
    settlePayment
      ΓêÜ should settle off-chain transaction (1 ms)
      ΓêÜ should return error for non-existent transaction
      ΓêÜ should return error for transaction without escrow 
(1 ms)
    refundPayment
      ΓêÜ should refund off-chain transaction (1 ms)
      ΓêÜ should return error for non-existent transaction
    getPaymentStatus
      ΓêÜ should return null for non-existent transaction (1 
ms)
      ΓêÜ should return DB-based status for off-chain escrow 
(1 ms)
    generatePaymentHeader
      ΓêÜ should generate correct x402 payment headers (1 ms)
      ΓêÜ should handle zero amount
    edge cases
      ΓêÜ should handle double-settle gracefully (1 ms)
      ΓêÜ should create escrow with large USDC amount (2 ms)
      ΓêÜ should create escrow with zero amount
      ΓêÜ should handle refund for already-refunded 
transaction
      ΓêÜ should return error for refund without escrow (1 ms)
      ΓêÜ should return status with releasedAt timestamp
      ΓêÜ should generate headers with custom escrow ID (1 ms)

PASS tests/unit/nft.service.test.ts
  NFTService
    mintLeadNFT
      ΓêÜ should return error for non-existent lead (1 ms)
      ΓêÜ should return existing tokenId if already minted (1 
ms)
      ΓêÜ should create off-chain pseudo-tokenId when no 
contract (1 ms)
    recordSaleOnChain
      ΓêÜ should succeed for off-chain token (logged only) (1 
ms)
    getTokenMetadata
      ΓêÜ should return null for non-existent token (1 ms)
      ΓêÜ should return DB-based metadata for off-chain token 
(1 ms)
    updateQualityScoreOnChain
      ΓêÜ should succeed silently for off-chain token (no-op)
    mintLeadNFT (dataHash branch)
      ΓêÜ should use existing dataHash when available (3 ms)
      ΓêÜ should handle lead with no geo state (1 ms)
      ΓêÜ should handle lead with no seller wallet (1 ms)
    getTokenMetadata (field coverage)
      ΓêÜ should populate all metadata fields from DB (1 ms)
      ΓêÜ should return null dataHash as ZeroHash (1 ms)
    recordSaleOnChain (coverage)
      ΓêÜ should handle zero sale price

PASS tests/auto-bid.test.ts
  Auto-Bid Service
    Quality Score Gate
      ΓêÜ should bid when lead score exceeds minimum (2 ms)
      ΓêÜ should skip when lead score is below minimum (bid 
if score > 80 = 8000) (1 ms)
      ΓêÜ should bid when no quality score gate is set (2 ms)
    Geo Include/Exclude Filtering
      ΓêÜ should bid when state is in include list (1 ms)
      ΓêÜ should skip when state is NOT in include list (1 ms)
      ΓêÜ should skip when state is in exclude list (2 ms)
      ΓêÜ should skip when country does not match (1 ms)
    Off-Site Lead Rejection
      ΓêÜ should reject off-site lead when acceptOffSite is 
false (2 ms)
      ΓêÜ should accept off-site lead when acceptOffSite is 
true (2 ms)
    Daily Budget Enforcement
      ΓêÜ should skip when daily budget would be exceeded (1 
ms)
      ΓêÜ should bid when within daily budget (1 ms)
    Verified-Only Toggle
      ΓêÜ should skip unverified lead when requireVerified is 
true (2 ms)
    Reserve Price Check
      ΓêÜ should skip when bid amount is below reserve (1 ms)
    Multi-Buyer Concurrent Auto-Bid
      ΓêÜ should place bids for multiple matching buyers on 
the same lead (9 ms)
    Vertical-Specific Rules (Solar vs Mortgage)
      ΓêÜ should only match preference sets for the correct 
vertical (1 ms)
      ΓêÜ should return empty when no preference sets match 
the vertical (2 ms)
    Duplicate Bid Prevention
      ΓêÜ should skip if buyer already bid on this lead (1 ms)
    Max Bid Per Lead Cap
      ΓêÜ should skip when bid exceeds max per lead (1 ms)

FAIL tests/security/privacy-audit.test.ts
  Privacy Audit
    no plaintext leakage
      ΓêÜ should never contain original PII in ciphertext (1 
ms)
      ΓêÜ should never contain bid amount in ciphertext (2 ms)
      ├ù should never contain parameter values in token 
metadata encryption (1 ms)
    commitment integrity
      ΓêÜ should detect tampered bid (commitment mismatch on 
reveal) (1 ms)
      ΓêÜ should prevent bid amount manipulation (2 ms)
    AAD binding
      ΓêÜ should prevent buyer A from decrypting buyer B bid 
(1 ms)
      ΓêÜ should prevent case-altered address from decrypting 
(1 ms)
    PII at rest
      ΓêÜ should produce ciphertext of sufficient length for 
PII data (1 ms)
      ΓêÜ should not store PII fields in public metadata
    key sensitivity
      ΓêÜ should produce deterministic data hash for same PII 
(1 ms)

  ΓùÅ Privacy Audit ΓÇ║ no plaintext leakage ΓÇ║ should never 
contain parameter values in token metadata encryption

    expect(received).not.toContain(expected) // indexOf

    Expected substring: not "780"
    Received string:        "4c528bdb2a78075d2fc063fbb28f25a80
fa165b85128cba23a2974b70fa0bb6596f20e77591beb19fca472bee43c2e4
81ea22694c8c04b31ea5c00a154bf9f1d77e027bada9d7c1b982141d468774
0ef7fb3e6bf710b"

    [0m [90m 50 |[39m             expect(encryptedFields[3
3m![39m[33m.[39mciphertext)[33m.[39mnot[33m.[39mtoConta
in([32m'TopSecret'[39m)[33m;[39m
     [90m 51 |[39m             expect(encryptedFields[33m!
[39m[33m.[39mciphertext)[33m.[39mnot[33m.[39mtoContain(
[32m'999-99-9999'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 52 |[39m             expect(enc
ryptedFields[33m![39m[33m.[39mciphertext)[33m.[39mnot[3
3m.[39mtoContain([32m'780'[39m)[33m;[39m
     [90m    |[39m                                          
           [31m[1m^[22m[39m
     [90m 53 |[39m         })[33m;[39m
     [90m 54 |[39m     })[33m;[39m
     [90m 55 |[39m[0m

      at Object.<anonymous> 
(tests/security/privacy-audit.test.ts:52:53)

PASS tests/e2e/demo-flow.test.ts
  E2E Demo Flow
    full pipeline simulation
      ΓêÜ should complete all 8 steps successfully (4 ms)
      ΓêÜ should handle non-compliant buyer (ACE blocked)
      ΓêÜ should handle wrong buyer address in bid reveal (1 
ms)
    ZK + Privacy cross-service
      ΓêÜ should generate matching ZK proof and privacy 
commitment for same lead (2 ms)
      ΓêÜ should geo-match mortgage lead to CA buyer criteria 
(1 ms)

PASS tests/compliance/ace-simulation.test.ts
  ACE Compliance Simulation
    cross-border: NY mortgage cross-border
      ΓêÜ FLΓåÆNY mortgage: BLOCKED
    cross-border: NY mortgage cross-border (reverse)
      ΓêÜ NYΓåÆFL mortgage: BLOCKED (2 ms)
    cross-border: CA mortgage cross-border
      ΓêÜ CAΓåÆTX mortgage: BLOCKED
    cross-border: FL mortgage cross-border
      ΓêÜ FLΓåÆTX mortgage: BLOCKED (1 ms)
    cross-border: TXΓåÆCO unrestricted
      ΓêÜ TXΓåÆCO mortgage: ALLOWED
    cross-border: WAΓåÆOR unrestricted
      ΓêÜ WAΓåÆOR mortgage: ALLOWED
    cross-border: MAΓåÆOH unrestricted (MA not in list)
      ΓêÜ MAΓåÆOH mortgage: ALLOWED (1 ms)
    cross-border: NY insurance cross-border
      ΓêÜ TXΓåÆNY insurance: BLOCKED
    cross-border: CAΓåÆFL insurance (CA not restricted for 
insurance)
      ΓêÜ CAΓåÆFL insurance: ALLOWED
    cross-border: FLΓåÆGA unrestricted insurance
      ΓêÜ FLΓåÆGA insurance: ALLOWED (1 ms)
    cross-border: Solar unrestricted
      ΓêÜ FLΓåÆCA solar: ALLOWED
    cross-border: Solar unrestricted NYΓåÆTX
      ΓêÜ NYΓåÆTX solar: ALLOWED (1 ms)
    cross-border: Solar unrestricted CAΓåÆWA
      ΓêÜ CAΓåÆWA solar: ALLOWED (1 ms)
    cross-border: Roofing unrestricted
      ΓêÜ FLΓåÆNY roofing: ALLOWED
    cross-border: Same-state mortgage NY
      ΓêÜ NYΓåÆNY mortgage: ALLOWED (1 ms)
    cross-border: Same-state insurance CA
      ΓêÜ CAΓåÆCA insurance: ALLOWED
    cross-border: Same-state solar FL
      ΓêÜ FLΓåÆFL solar: ALLOWED (3 ms)
    reputation scenarios
      ΓêÜ reputation 0 + 100 = 100 (1 ms)
      ΓêÜ reputation 5000 + 500 = 5500 (1 ms)
      ΓêÜ reputation 9900 + 200 = 10000 (1 ms)
      ΓêÜ reputation 100 + -500 = 0
      ΓêÜ reputation 10000 + 0 = 10000 (1 ms)
      ΓêÜ reputation 0 + 0 = 0 (1 ms)
      ΓêÜ reputation 3000 + -3000 = 0
      ΓêÜ reputation 7500 + 2500 = 10000 (1 ms)
    off-site API fraud edge cases
      ΓêÜ should block known fraudulent wallet (blacklist 
hit) (1 ms)
      ΓêÜ should handle wallet with no history (first 
interaction) (1 ms)
      ΓêÜ should auto-KYC new wallet and persist (1 ms)
      ΓêÜ should handle rapid sequential compliance checks (2 
ms)
    jurisdiction policy enforcement
      ΓêÜ should allow when no DB restriction (1 ms)
      ΓêÜ should block when DB has failed check (1 ms)

PASS tests/unit/zk.service.test.ts
  ZKService
    generateFraudProof
      ΓêÜ should generate a valid fraud proof with all fields 
(3 ms)
      ΓêÜ should produce different proofs for different leads 
(5 ms)
      ΓêÜ should handle missing optional fields (1 ms)
    verifyProofLocally
      ΓêÜ should verify a valid fraud proof (1 ms)
      ΓêÜ should reject an empty/zero proof (1 ms)
      ΓêÜ should reject a proof with no public inputs (1 ms)
      ΓêÜ should reject a proof with zero commitment (1 ms)
    generateGeoParameterMatchProof
      ΓêÜ should detect matching geo state (1 ms)
      ΓêÜ should detect non-matching geo state (1 ms)
      ΓêÜ should detect parameter threshold failures (1 ms)
    generateBidCommitment
      ΓêÜ should generate a valid bid commitment
      ΓêÜ should produce unique commitments for same amount 
(random salts) (1 ms)

----------------------|---------|----------|---------|---------|--------------------------------------------------------------------
File                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                  
----------------------|---------|----------|---------|---------|--------------------------------------------------------------------
All files             |   72.02 |    69.63 |   88.37 |   71.94 |                                                                    
 routes               |   69.64 |    71.64 |   85.71 |   70.96 |                                                                    
  crm.routes.ts       |   69.64 |    71.64 |   85.71 |   70.96 | 43-44,61-62,81-142,198-199,253-259,273-285,300-301,306-307,316-329 
 services             |   72.68 |     68.8 |   89.65 |    72.2 |                                                                    
  ace.service.ts      |    64.7 |    69.81 |     100 |    64.4 | 38-42,67-84,121-130,144-148,195,239-251,258,298-318,397-405        
  auto-bid.service.ts |   88.88 |    69.23 |      80 |   88.57 | 207,241-265                                                        
  cre.service.ts      |   75.14 |    75.78 |      80 |   74.37 | 43-47,171-175,261-262,293-294,298-308,333-357,374-383              
  nft.service.ts      |   57.14 |    64.15 |   71.42 |   56.52 | 53,57,91-129,158-164,178-198,233-239                               
  privacy.service.ts  |   98.21 |     87.5 |     100 |   98.21 | 31                                                                 
  x402.service.ts     |   51.28 |    49.09 |     100 |   50.64 | 57,61,67,87-125,157-173,203-215,241-255                            
  zk.service.ts       |      90 |     87.5 |     100 |      90 | 108-109,116-117                                                    
----------------------|---------|----------|---------|---------|--------------------------------------------------------------------

=============================== Coverage summary ===============================
Statements   : 72.02% ( 556/772 )
Branches     : 69.63% ( 321/461 )
Functions    : 88.37% ( 76/86 )
Lines        : 71.94% ( 536/745 )
================================================================================
Test Suites: 1 failed, 10 passed, 11 total
Tests:       1 failed, 191 passed, 192 total
Snapshots:   0 total
Time:        2.818 s
