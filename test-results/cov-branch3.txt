  console.error
    x402 getPaymentStatus on-chain failed: TypeError: this.escrowContract.getEscrow is not a function
        at X402Service.getPaymentStatus (C:\Users\Bruce\Projects\Lead Engine CRE\backend\src\services\x402.service.ts:242:58)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at async Object.<anonymous> (C:\Users\Bruce\Projects\Lead Engine CRE\backend\tests\unit\branch-gaps.test.ts:308:24)

    [0m [90m 253 |[39m                 }[33m;[39m
     [90m 254 |[39m             } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 255 |[39m                 console[33m.[39merror([32m'x402 getPaymentStatus on-chain failed:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m                         [31m[1m^[22m[39m
     [90m 256 |[39m             }
     [90m 257 |[39m         }
     [90m 258 |[39m[0m

      at X402Service.getPaymentStatus (src/services/x402.service.ts:255:25)
      at async Object.<anonymous> (tests/unit/branch-gaps.test.ts:308:24)

FAIL tests/unit/branch-gaps.test.ts
  ZK Service â€” branch gaps
    âˆš should fail parameterMatch when parameter is undefined (line 107-109) (5 ms)
    âˆš should fail parameterMatch on string mismatch (line 115-117) (2 ms)
    âˆš should pass parameterMatch on string equality (1 ms)
    âˆš should handle empty targetStates (line 101 geoMatch = true) (2 ms)
  CRE Service â€” branch gaps
    âˆš getQualityScore: on-chain returns positive score (line 171-173) (1 ms)
    âˆš getQualityScore: on-chain returns 0 â†’ falls through to off-chain (line 173 false branch)
    âˆš getQualityScore: on-chain error â†’ falls back to off-chain (line 174-175) (1 ms)
    Ã— matchLeadToAsk: param match with string equality (line 261-262) (2 ms)
    âˆš requestZKFraudDetection: local proof fails (line 293-294) (2 ms)
  X402 Service â€” branch gaps
    âˆš settlePayment: on-chain settle path (1 ms)
    âˆš refundPayment: on-chain refund path (1 ms)
    âˆš getPaymentStatus: on-chain status query (12 ms)
  Auto-Bid â€” branch gaps
    âˆš should handle null qualityScore with quality gate (line 117) (2 ms)
    âˆš should handle lead with undefined geo fields in batch (line 253-254) (3 ms)
  CRM Routes â€” webhook branch gaps
    âˆš handles circuit breaker paths via repeated failures (1 ms)
    âˆš handles rate-limited webhooks

  â— CRE Service â€” branch gaps â€º matchLeadToAsk: param match with string equality (line 261-262)

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 199 |[39m         [36mconst[39m result [33m=[39m [36mawait[39m creService[33m.[39mmatchLeadToAsk([32m'pm-str-lead'[39m[33m,[39m [32m'ask-1'[39m)[33m;[39m
     [90m 200 |[39m
    [31m[1m>[22m[39m[90m 201 |[39m         expect(result[33m.[39mmatches)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 202 |[39m         expect(result[33m.[39mdetails[33m.[39msome((d[33m:[39m string) [33m=>[39m d[33m.[39mincludes([32m'Parameters'[39m)))[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 203 |[39m     })[33m;[39m
     [90m 204 |[39m[0m

      at Object.<anonymous> (tests/unit/branch-gaps.test.ts:201:32)

PASS tests/unit/privacy.service.test.ts
  PrivacyService
    encrypt/decrypt round-trip
      âˆš should encrypt and decrypt lead PII correctly (3 ms)
      âˆš should produce different ciphertext for same plaintext (unique IV) (2 ms)
      âˆš should throw on tampered ciphertext (3 ms)
      âˆš should throw on tampered auth tag (1 ms)
    encryptBid / decryptBid
      âˆš should encrypt bid and decrypt with valid commitment (2 ms)
      âˆš should fail reveal with wrong buyer address (AAD mismatch) (3 ms)
      âˆš should produce unique commitments for same amount (different salts) (1 ms)
      âˆš should handle small and large amounts (1 ms)
    encryptTokenMetadata / decryptTokenMetadata
      âˆš should keep public fields visible and encrypt private fields (1 ms)
      âˆš should return null encryptedFields when no PII or parameters (1 ms)
    generateCommitment / verifyCommitment
      âˆš should generate and verify a valid commitment (2 ms)
      âˆš should fail verification with wrong value (1 ms)
      âˆš should fail verification with wrong salt (1 ms)

PASS tests/crm-webhooks.test.ts
  CRM Webhooks
    Webhook Registration
      âˆš should register a generic webhook (53 ms)
      âˆš should register a HubSpot webhook (8 ms)
      âˆš should register a Zapier webhook (6 ms)
      âˆš should reject missing URL (6 ms)
      âˆš should reject invalid format (7 ms)
    Webhook Listing
      âˆš should list user webhooks (11 ms)
    Webhook Deletion
      âˆš should delete an existing webhook (11 ms)
      âˆš should return 404 for non-existent webhook (5 ms)
    HubSpot Payload Format
      âˆš should transform leads to HubSpot contact properties (7 ms)
    Zapier Payload Format
      âˆš should produce flat key-value objects for Zapier (6 ms)
    CRM Export
      âˆš should return JSON export (5 ms)
      âˆš should return CSV export (6 ms)
    CRM Push
      âˆš should return error when no webhook URL provided (5 ms)
      âˆš should push leads with specific leadIds (6 ms)
      âˆš should push default SOLD leads when no leadIds provided (5 ms)
      âˆš should return 502 when webhook URL returns error (5 ms)
    Generic Webhook Format
      âˆš should fire generic format with standard payload (5 ms)
    CRM Export (country filter)
      âˆš should filter leads by country when specified (6 ms)
      âˆš should return 500 on export error (4 ms)
    fireCRMWebhooks (resilience)
      âˆš should increment failure count when webhook fetch throws (1 ms)
      âˆš should handle empty leads array
    Event Filtering
      âˆš should skip webhooks not subscribed to event

PASS tests/unit/onchain-branches.test.ts
  ACE On-Chain Branches
    âˆš isKYCValid: should call contract.isKYCValid on-chain (2 ms)
    âˆš isKYCValid: should catch on-chain error and fallback to DB (2 ms)
    âˆš canTransact: should call contract.canTransact on-chain (5 ms)
    âˆš canTransact: on-chain returns false (1 ms)
    âˆš canTransact: on-chain error falls back gracefully (1 ms)
    âˆš getReputationScore: should call contract on-chain (1 ms)
    âˆš getReputationScore: on-chain error falls back to DB (1 ms)
    âˆš enforceJurisdictionPolicy: on-chain allowed (1 ms)
    âˆš enforceJurisdictionPolicy: on-chain blocked (2 ms)
    âˆš enforceJurisdictionPolicy: on-chain error falls back (1 ms)
    âˆš autoKYC: on-chain success (1 ms)
    âˆš autoKYC: on-chain failure (3 ms)
    âˆš updateReputation: on-chain success
    âˆš updateReputation: on-chain failure
  CRE On-Chain Branches
    âˆš requestZKFraudDetection: on-chain success (2 ms)
    âˆš requestZKFraudDetection: on-chain error falls back to local (1 ms)
    âˆš requestParameterMatchOnChain: on-chain success (1 ms)
    âˆš requestParameterMatchOnChain: on-chain error
    âˆš requestGeoValidationOnChain: on-chain success
    âˆš requestGeoValidationOnChain: on-chain error (1 ms)
  NFT On-Chain Branches
    âˆš mintLeadNFT: on-chain mint success (1 ms)
    âˆš mintLeadNFT: on-chain error falls back (1 ms)
    âˆš recordSaleOnChain: on-chain success
    âˆš recordSaleOnChain: on-chain error (1 ms)
    âˆš getTokenMetadata: on-chain success (1 ms)
    âˆš getTokenMetadata: on-chain error falls back to DB (1 ms)
  X402 On-Chain Branches
    âˆš createPayment: on-chain with USDC approval (1 ms)
    âˆš createPayment: on-chain without USDC (no usdc contract)
    âˆš createPayment: on-chain error (1 ms)
    âˆš settlePayment: on-chain release (1 ms)
    âˆš settlePayment: on-chain error (1 ms)
    âˆš refundPayment: on-chain refund (1 ms)
    âˆš refundPayment: on-chain error
    âˆš getPaymentStatus: on-chain status (1 ms)
    âˆš getPaymentStatus: on-chain error falls back to DB
    âˆš createPayment: on-chain with sufficient USDC allowance (skip approve) (1 ms)
  NFT updateQualityScoreOnChain On-Chain
    âˆš updateQualityScoreOnChain: on-chain success (1 ms)
    âˆš updateQualityScoreOnChain: on-chain error (1 ms)
    âˆš updateQualityScoreOnChain: skips for offchain token (1 ms)

  console.warn
    CRE: unknown country code "ZZ" for lead lead-xx

    [0m [90m 146 |[39m         [36mif[39m ([33m![39mgetAllCountryCodes()[33m.[39mincludes(country)) {
     [90m 147 |[39m             [90m// Allow unknown countries â€” don't block, just log[39m
    [31m[1m>[22m[39m[90m 148 |[39m             console[33m.[39mwarn([32m`CRE: unknown country code "${country}" for lead ${lead.id}`[39m)[33m;[39m
     [90m     |[39m                     [31m[1m^[22m[39m
     [90m 149 |[39m             [36mawait[39m [36mthis[39m[33m.[39mlogCheck(lead[33m.[39mid[33m,[39m [32m'GEO_VALIDATION'[39m[33m,[39m [32m'PASSED'[39m[33m,[39m [32m`Unknown country ${country} â€” allowed`[39m)[33m;[39m
     [90m 150 |[39m             [36mreturn[39m { isValid[33m:[39m [36mtrue[39m }[33m;[39m
     [90m 151 |[39m         }[0m

      at CREService.verifyGeo (src/services/cre.service.ts:148:21)
      at CREService.verifyLead (src/services/cre.service.ts:70:18)
      at async Object.<anonymous> (tests/unit/cre.service.test.ts:409:28)

PASS tests/unit/cre.service.test.ts
  CREService
    verifyLead
      âˆš should return invalid for non-existent lead (1 ms)
      âˆš should return valid for already-verified lead (1 ms)
      âˆš should fail for lead without TCPA consent (1 ms)
      âˆš should fail for lead with expired TCPA consent (1 ms)
      âˆš should fail for invalid US state (1 ms)
      âˆš should pass for valid lead with all checks (2 ms)
      âˆš should fail for data integrity mismatch (1 ms)
    getQualityScore
      âˆš should return 0 for non-existent lead (1 ms)
      âˆš should return base score for minimal lead (3 ms)
      âˆš should add bonuses for verified lead with all fields (1 ms)
      âˆš should cap quality score at 10000 (1 ms)
    matchLeadToAsk
      âˆš should return no match for nonexistent lead or ask
      âˆš should reject on vertical mismatch
      âˆš should match with correct vertical and geo (1 ms)
      âˆš should reject when lead geo not in targeted states
      âˆš should add score for meeting reserve price (1 ms)
      âˆš should match using "regions" key (not just "states")
      âˆš should reject on country mismatch
      âˆš should add geo bonus when no region restrictions (1 ms)
    requestZKFraudDetection
      âˆš should return invalid for non-existent lead
      âˆš should verify locally and return valid for existing lead (4 ms)
    requestParameterMatchOnChain
      âˆš should return error when contract not configured
    requestGeoValidationOnChain
      âˆš should return error when contract not configured (1 ms)
    verifyLead (geo edge cases)
      âˆš should fail for lead with no geo data (1 ms)
      âˆš should allow lead with unknown country code (4 ms)

PASS tests/unit/ace.service.test.ts
  ACEService
    enforceJurisdictionPolicy
      âˆš should allow when no restrictions exist in DB (2 ms)
      âˆš should block when DB restriction exists (1 ms)
    checkCrossBorderCompliance
      âˆš should allow same-state transactions
      âˆš should block cross-state mortgage with restricted states (1 ms)
      âˆš should block cross-state insurance with NY (1 ms)
      âˆš should allow cross-state solar (unrestricted vertical)
      âˆš should allow cross-state mortgage between unrestricted states (1 ms)
      âˆš should handle CA mortgage cross-border restriction (3 ms)
    autoKYC
      âˆš should create KYC check in database (off-chain) (1 ms)
      âˆš should set 1-year expiry on KYC check (1 ms)
    updateReputation
      âˆš should update reputation in DB for existing seller (1 ms)
      âˆš should clamp reputation at 0 (floor)
      âˆš should clamp reputation at 10000 (ceiling) (1 ms)
      âˆš should return error for non-existent seller (1 ms)
    isKYCValid
      âˆš should return false for unknown wallet (off-chain) (1 ms)
      âˆš should return true for valid KYC in DB
    canTransact
      âˆš should block blacklisted user (1 ms)
      âˆš should block user without KYC (1 ms)
      âˆš should allow valid user with KYC
    getReputationScore
      âˆš should return DB score for existing seller (1 ms)
      âˆš should return default 5000 for unknown wallet
    isBlacklisted
      âˆš should return true when fraud check exists (1 ms)
      âˆš should return false when no fraud check
    checkFullCompliance
      âˆš should pass when both parties are compliant and lead has TCPA (1 ms)
      âˆš should fail when seller is blacklisted (1 ms)
      âˆš should fail when lead not found
      âˆš should fail when lead has no TCPA consent (1 ms)
    enforceJurisdictionPolicy (policy branch)
      âˆš should allow unrestricted country vertical (2 ms)
    autoKYC (proofHash branch)
      âˆš should accept custom proofHash (1 ms)
    checkCrossBorderCompliance (cross-country)
      âˆš should return requirements for USâ†’EU cross-country trade
    edge cases
      âˆš should handle empty wallet address gracefully (1 ms)
      âˆš should handle cross-border with empty vertical
      âˆš should return true for user with VERIFIED buyerProfile (1 ms)

PASS tests/compliance/ace-simulation.test.ts
  ACE Compliance Simulation
    cross-border: NY mortgage cross-border
      âˆš FLâ†’NY mortgage: BLOCKED (2 ms)
    cross-border: NY mortgage cross-border (reverse)
      âˆš NYâ†’FL mortgage: BLOCKED (1 ms)
    cross-border: CA mortgage cross-border
      âˆš CAâ†’TX mortgage: BLOCKED
    cross-border: FL mortgage cross-border
      âˆš FLâ†’TX mortgage: BLOCKED (1 ms)
    cross-border: TXâ†’CO unrestricted
      âˆš TXâ†’CO mortgage: ALLOWED (1 ms)
    cross-border: WAâ†’OR unrestricted
      âˆš WAâ†’OR mortgage: ALLOWED
    cross-border: MAâ†’OH unrestricted (MA not in list)
      âˆš MAâ†’OH mortgage: ALLOWED (1 ms)
    cross-border: NY insurance cross-border
      âˆš TXâ†’NY insurance: BLOCKED (1 ms)
    cross-border: CAâ†’FL insurance (CA not restricted for insurance)
      âˆš CAâ†’FL insurance: ALLOWED
    cross-border: FLâ†’GA unrestricted insurance
      âˆš FLâ†’GA insurance: ALLOWED (2 ms)
    cross-border: Solar unrestricted
      âˆš FLâ†’CA solar: ALLOWED
    cross-border: Solar unrestricted NYâ†’TX
      âˆš NYâ†’TX solar: ALLOWED (1 ms)
    cross-border: Solar unrestricted CAâ†’WA
      âˆš CAâ†’WA solar: ALLOWED
    cross-border: Roofing unrestricted
      âˆš FLâ†’NY roofing: ALLOWED (1 ms)
    cross-border: Same-state mortgage NY
      âˆš NYâ†’NY mortgage: ALLOWED
    cross-border: Same-state insurance CA
      âˆš CAâ†’CA insurance: ALLOWED (1 ms)
    cross-border: Same-state solar FL
      âˆš FLâ†’FL solar: ALLOWED
    reputation scenarios
      âˆš reputation 0 + 100 = 100 (1 ms)
      âˆš reputation 5000 + 500 = 5500
      âˆš reputation 9900 + 200 = 10000
      âˆš reputation 100 + -500 = 0
      âˆš reputation 10000 + 0 = 10000
      âˆš reputation 0 + 0 = 0 (1 ms)
      âˆš reputation 3000 + -3000 = 0 (2 ms)
      âˆš reputation 7500 + 2500 = 10000 (1 ms)
    off-site API fraud edge cases
      âˆš should block known fraudulent wallet (blacklist hit)
      âˆš should handle wallet with no history (first interaction) (1 ms)
      âˆš should auto-KYC new wallet and persist (1 ms)
      âˆš should handle rapid sequential compliance checks (3 ms)
    jurisdiction policy enforcement
      âˆš should allow when no DB restriction (1 ms)
      âˆš should block when DB has failed check (1 ms)

PASS tests/unit/x402.service.test.ts
  X402Service
    createPayment
      âˆš should create off-chain escrow when no contract configured (3 ms)
    settlePayment
      âˆš should settle off-chain transaction (1 ms)
      âˆš should return error for non-existent transaction
      âˆš should return error for transaction without escrow (1 ms)
    refundPayment
      âˆš should refund off-chain transaction (1 ms)
      âˆš should return error for non-existent transaction (1 ms)
    getPaymentStatus
      âˆš should return null for non-existent transaction
      âˆš should return DB-based status for off-chain escrow (3 ms)
    generatePaymentHeader
      âˆš should generate correct x402 payment headers (1 ms)
      âˆš should handle zero amount
    edge cases
      âˆš should handle double-settle gracefully (1 ms)
      âˆš should create escrow with large USDC amount (1 ms)
      âˆš should create escrow with zero amount
      âˆš should handle refund for already-refunded transaction (1 ms)
      âˆš should return error for refund without escrow
      âˆš should return status with releasedAt timestamp (1 ms)
      âˆš should generate headers with custom escrow ID (1 ms)

PASS tests/unit/nft.service.test.ts
  NFTService
    mintLeadNFT
      âˆš should return error for non-existent lead (2 ms)
      âˆš should return existing tokenId if already minted (1 ms)
      âˆš should create off-chain pseudo-tokenId when no contract (2 ms)
    recordSaleOnChain
      âˆš should succeed for off-chain token (logged only) (1 ms)
    getTokenMetadata
      âˆš should return null for non-existent token (1 ms)
      âˆš should return DB-based metadata for off-chain token (1 ms)
    updateQualityScoreOnChain
      âˆš should succeed silently for off-chain token (no-op)
    mintLeadNFT (dataHash branch)
      âˆš should use existing dataHash when available (2 ms)
      âˆš should handle lead with no geo state (1 ms)
      âˆš should handle lead with no seller wallet (1 ms)
    getTokenMetadata (field coverage)
      âˆš should populate all metadata fields from DB (1 ms)
      âˆš should return null dataHash as ZeroHash (1 ms)
    recordSaleOnChain (coverage)
      âˆš should handle zero sale price

PASS tests/security/privacy-audit.test.ts
  Privacy Audit
    no plaintext leakage
      âˆš should never contain original PII in ciphertext (2 ms)
      âˆš should never contain bid amount in ciphertext (1 ms)
      âˆš should never contain parameter values in token metadata encryption (1 ms)
    commitment integrity
      âˆš should detect tampered bid (commitment mismatch on reveal) (3 ms)
      âˆš should prevent bid amount manipulation (3 ms)
    AAD binding
      âˆš should prevent buyer A from decrypting buyer B bid (1 ms)
      âˆš should prevent case-altered address from decrypting
    PII at rest
      âˆš should produce ciphertext of sufficient length for PII data (1 ms)
      âˆš should not store PII fields in public metadata (1 ms)
    key sensitivity
      âˆš should produce deterministic data hash for same PII (1 ms)

PASS tests/unit/zk.service.test.ts
  ZKService
    generateFraudProof
      âˆš should generate a valid fraud proof with all fields (5 ms)
      âˆš should produce different proofs for different leads (5 ms)
      âˆš should handle missing optional fields (1 ms)
    verifyProofLocally
      âˆš should verify a valid fraud proof (1 ms)
      âˆš should reject an empty/zero proof
      âˆš should reject a proof with no public inputs (1 ms)
      âˆš should reject a proof with zero commitment (1 ms)
    generateGeoParameterMatchProof
      âˆš should detect matching geo state (1 ms)
      âˆš should detect non-matching geo state (1 ms)
      âˆš should detect parameter threshold failures (1 ms)
    generateBidCommitment
      âˆš should generate a valid bid commitment (1 ms)
      âˆš should produce unique commitments for same amount (random salts)

PASS tests/e2e/demo-flow.test.ts
  E2E Demo Flow
    full pipeline simulation
      âˆš should complete all 8 steps successfully (9 ms)
      âˆš should handle non-compliant buyer (ACE blocked) (1 ms)
      âˆš should handle wrong buyer address in bid reveal (1 ms)
    ZK + Privacy cross-service
      âˆš should generate matching ZK proof and privacy commitment for same lead (2 ms)
      âˆš should geo-match mortgage lead to CA buyer criteria (2 ms)

PASS tests/auto-bid.test.ts
  Auto-Bid Service
    Quality Score Gate
      âˆš should bid when lead score exceeds minimum (2 ms)
      âˆš should skip when lead score is below minimum (bid if score > 80 = 8000)
      âˆš should bid when no quality score gate is set (1 ms)
    Geo Include/Exclude Filtering
      âˆš should bid when state is in include list (1 ms)
      âˆš should skip when state is NOT in include list (1 ms)
      âˆš should skip when state is in exclude list (1 ms)
      âˆš should skip when country does not match
    Off-Site Lead Rejection
      âˆš should reject off-site lead when acceptOffSite is false (1 ms)
      âˆš should accept off-site lead when acceptOffSite is true (1 ms)
    Daily Budget Enforcement
      âˆš should skip when daily budget would be exceeded
      âˆš should bid when within daily budget
    Verified-Only Toggle
      âˆš should skip unverified lead when requireVerified is true (1 ms)
    Reserve Price Check
      âˆš should skip when bid amount is below reserve
    Multi-Buyer Concurrent Auto-Bid
      âˆš should place bids for multiple matching buyers on the same lead (1 ms)
    Vertical-Specific Rules (Solar vs Mortgage)
      âˆš should only match preference sets for the correct vertical (2 ms)
      âˆš should return empty when no preference sets match the vertical (1 ms)
    Duplicate Bid Prevention
      âˆš should skip if buyer already bid on this lead
    Max Bid Per Lead Cap
      âˆš should skip when bid exceeds max per lead (1 ms)
    Batch Evaluate Leads
      âˆš should evaluate batch of leads from DB (1 ms)
      âˆš should return empty results for no matching leads (1 ms)
      âˆš should handle bid creation errors in batch

----------------------|---------|----------|---------|---------|-----------------------------------------------------------------
File                  | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                               
----------------------|---------|----------|---------|---------|-----------------------------------------------------------------
All files             |   94.55 |    88.72 |   97.67 |   95.03 |                                                                 
 routes               |   84.52 |    85.82 |   92.85 |   86.45 |                                                                 
  crm.routes.ts       |   84.52 |    85.82 |   92.85 |   86.45 | 141-142,198-199,253-259,273-277,282-283,300-301,306-307,328-329 
 services             |   97.35 |     89.9 |     100 |   97.28 |                                                                 
  ace.service.ts      |   94.95 |    90.56 |     100 |   94.91 | 38-42,195,258                                                   
  auto-bid.service.ts |     100 |     92.3 |     100 |     100 | 234,259-260                                                     
  cre.service.ts      |   97.63 |    90.52 |     100 |    97.5 | 43-47                                                           
  nft.service.ts      |   97.14 |    88.67 |     100 |    97.1 | 53,57                                                           
  privacy.service.ts  |   98.21 |     87.5 |     100 |   98.21 | 31                                                              
  x402.service.ts     |   96.15 |    83.63 |     100 |    96.1 | 57,61,67                                                        
  zk.service.ts       |     100 |      100 |     100 |     100 |                                                                 
----------------------|---------|----------|---------|---------|-----------------------------------------------------------------
Test Suites: 1 failed, 12 passed, 13 total
Tests:       1 failed, 256 passed, 257 total
Snapshots:   0 total
Time:        3.494 s
Ran all test suites.

---STDERR---
